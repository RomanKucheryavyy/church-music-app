<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUBC Program Studio</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="/social-logo.png?v=2">

    <style>
        :root { --bg-color: #f8fafc; --surface-color: #ffffff; --text-primary: #0f172a; --border-color: #e2e8f0; --accent-color: #b45309; --preview-bg: #cbd5e1; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-primary); margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        header { width: 100%; background-color: var(--surface-color); padding: 15px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; z-index: 10; }
        header h1 { margin: 0; font-family: 'Montserrat', sans-serif; font-size: 18px; font-weight: 700; letter-spacing: 0.05em; }
        
        #login-wall { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; width: 100%; text-align: center; }
        .login-btn { background: var(--text-primary); color: white; padding: 12px 24px; border-radius: 6px; font-weight: bold; border: none; cursor: pointer; margin-top: 20px; }

        .container { width: 100%; height: 100%; display: none; grid-template-columns: 450px 1fr; overflow: hidden; }
        .panel-builder { background: var(--surface-color); border-right: 1px solid var(--border-color); padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 5px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }
        input, select { width: 100%; padding: 10px; background: #f1f5f9; color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; box-sizing: border-box; outline: none; transition: border 0.2s; }
        
        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; background: #f8fafc; border: 1px solid var(--border-color); border-radius: 8px; }
        
        .program-row { display: flex; gap: 6px; align-items: center; background: white; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .drag-handle { cursor: grab; color: #94a3b8; font-size: 16px; padding: 0 4px; }
        
        .program-row .type-input { width: 30%; font-size: 12px; padding: 8px 6px; font-weight: bold;}
        .program-row .desc-input { width: 45%; font-size: 13px; font-weight: 500; padding: 8px 6px; }
        .program-row .duration-input { width: 15%; font-size: 12px; padding: 8px 2px; text-align: center; background: #fffbeb; border-color: #fde68a; }
        
        .delete-btn { color: #ef4444; border: none; background: none; font-weight: bold; cursor: pointer; padding: 0 6px; font-size: 18px; }

        button { border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; padding: 12px; border: none; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        button.primary { background: var(--accent-color); color: white; width: 100%; box-shadow: 0 4px 6px -1px rgba(180, 83, 9, 0.3); }
        button.secondary { background: white; border: 1px solid var(--border-color); color: var(--text-primary); }
        button.cloud-btn { background: #10b981; color: white; width: 100%; margin-top: 10px; }
        button.cloud-btn:hover { background: #059669; }
        
        .run-clock { display: flex; justify-content: space-between; align-items: center; background: #0f172a; color: white; padding: 10px 15px; border-radius: 6px; font-size: 12px; font-weight: 600; margin-top: 10px; }
        .run-clock span.highlight { color: #fde047; font-size: 14px; }

        /* PREVIEW SCALING LOGIC */
        #pdf-preview-wrapper { background-color: var(--preview-bg); padding: 40px; overflow: auto; display: flex; justify-content: center; align-items: flex-start; }
        
        .preview-scale-wrapper {
            transform-origin: top center;
            transition: transform 0.2s;
        }

        #pdf-preview-container { background: white; color: black; width: 8.5in; min-height: 11in; padding: 0.5in; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); text-align: center; box-sizing: border-box; position: relative; }
        #pdf-preview-container h1 { font-family: 'Montserrat', sans-serif; font-size: 32pt; margin-bottom: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: -1px; }
        #pdf-preview-container h3 { font-family: 'Inter', sans-serif; font-size: 16pt; font-weight: normal; margin-top: 0; margin-bottom: 30px; color: #444; border-bottom: 2px solid black; padding-bottom: 20px; display: inline-block; min-width: 60%; }
        .preview-item { margin-bottom: 0; width: 100%; display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
        .preview-type { font-weight: 800; color: #000; }
        .preview-desc { font-weight: 500; color: #000; }

        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 100; flex-direction: column; backdrop-filter: blur(2px); }

        /* PRINT STYLESHEET */
        @media print {
            body { background: white; }
            header, .panel-builder, #login-wall, #loading-overlay { display: none !important; }
            .container { display: block !important; }
            #pdf-preview-wrapper { background: none; padding: 0; overflow: visible; display: block; }
            .preview-scale-wrapper { transform: none !important; }
            #pdf-preview-container { width: 100%; height: auto; box-shadow: none; padding: 0; min-height: auto; }
        }
    </style>
</head>
<body>

    <div id="login-wall">
        <img src="/social-logo.png" style="width:80px; margin-bottom:20px; opacity:0.8;">
        <h2 style="font-family: 'Montserrat', sans-serif;">Authorized Access Only</h2>
        <button class="login-btn" onclick="netlifyIdentity.open()">Log In</button>
    </div>

    <datalist id="item-types-list">
        <option value="–î—É—Ö. –û—Ä–∫–µ—Å—Ç—Ä:"></option>
        <option value="–ó–∞–≥. –°–ø—ñ–≤:"></option>
        <option value="–ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è/–ú–æ–ª–∏—Ç–≤–∞"></option>
        <option value="–ü—Ä–æ–ø–æ–≤—ñ–¥—å"></option>
        <option value="–£—á–∞—Å—Ç—å:"></option>
        <option value="–ú–æ–ª–∏—Ç–≤–∞ –∑–∞ –£–∫—Ä–∞—ó–Ω—É"></option>
        <option value="–ó–∞–∫–ª—é—á–Ω–∞ –º–æ–ª–∏—Ç–≤–∞"></option>
        <option value="–û–≥–æ–ª–æ—à–µ–Ω–Ω—è"></option>
    </datalist>
    <datalist id="song-list-data"></datalist>

    <input type="file" id="pdf-upload" accept=".pdf" style="display:none" onchange="handlePdfImport(this)">
    <div id="loading-overlay">
        <div style="font-weight: bold; font-size: 18px; color: var(--accent-color);" id="debug-text">Working...</div>
    </div>

    <div class="main-wrapper" style="width: 100%; height: 100%; display: none; flex-direction: column;">
        <header>
            <h1>FUBC <span style="color: var(--accent-color)">PROGRAM STUDIO</span></h1>
            <div style="display: flex; gap: 20px; align-items: center;">
                <span id="user-name" style="font-size: 12px; font-weight: 600;"></span>
                <a onclick="logout()" style="color: #ef4444; cursor:pointer; font-weight:bold; font-size: 12px; text-transform: uppercase;">Log Out</a>
            </div>
        </header>

        <div class="container" style="display: grid;">
            <div class="panel-builder">
                <div style="background: #f1f5f9; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <label>‚òÅÔ∏è Cloud Templates</label>
                    <div style="display: flex; gap: 5px;">
                        <select id="cloud-templates" style="flex:1;"><option value="">-- Load Cloud Template --</option></select>
                        <button class="secondary" onclick="loadCloudTemplate()" style="padding: 5px 10px;">Load</button>
                        <button class="secondary" onclick="saveToCloud('template')" style="padding: 5px 10px;">Save As</button>
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="secondary" onclick="document.getElementById('pdf-upload').click()" style="flex:1; border-color: var(--accent-color); color: var(--accent-color); font-weight:bold;">üìÇ Import PDF</button>
                    <button class="secondary" onclick="loadDefault()" style="flex:1">Reset Form</button>
                </div>
                
                <div class="controls-grid">
                    <div><label>Date</label><input type="date" id="service-date" onchange="triggerUpdate()"></div>
                    <div><label>Start Time</label><input type="time" id="start-time" value="09:00" onchange="triggerUpdate()"></div>
                    <div><label>Font Size</label><input type="number" id="font-size" value="22" min="14" max="40" oninput="triggerUpdate()"></div>
                    <div><label>Spacing</label><select id="line-spacing" onchange="triggerUpdate()"><option value="1.4">Tight</option><option value="1.6" selected>Normal</option><option value="2.0">Wide</option></select></div>
                </div>

                <div class="run-clock">
                    <span>Total Time: <span id="total-min" class="highlight">0</span> min</span>
                    <span>Est. End: <span id="est-end" class="highlight">--:--</span></span>
                </div>

                <div style="flex: 1; overflow-y: auto;">
                    <label style="margin-top: 10px;">Program Order (Type | Description | Minutes)</label>
                    <div id="program-items"></div>
                    <button class="secondary" style="width: 100%; margin-top: 10px; border-style: dashed;" onclick="addProgramRow('', '', '')">+ Add Item</button>
                </div>

                <div style="margin-top: auto; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                    <button class="cloud-btn" onclick="saveToCloud('publish')">üöÄ Publish to Live Website</button>
                    <button class="viber" onclick="shareToViber()">üí¨ Copy Text for Viber</button>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <button class="primary" onclick="window.print()">üñ®Ô∏è Print Direct</button>
                        <button class="primary" onclick="generatePDF()">üì• Export PDF</button>
                    </div>
                </div>
            </div>
            
            <div id="pdf-preview-wrapper">
                <div class="preview-scale-wrapper" id="scale-wrapper">
                    <div id="pdf-preview-container">
                        <h1>–ü—Ä–æ–≥—Ä–∞–º–∞ —Å–ª—É–∂—ñ–Ω–Ω—è</h1>
                        <h3 id="preview-date">...</h3>
                        <div id="preview-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        let cloudDataGlobal = null; 

        function adjustScale() {
            const wrapper = document.getElementById('pdf-preview-wrapper');
            const scaleWrapper = document.getElementById('scale-wrapper');
            if(!wrapper || !scaleWrapper) return;
            const availableWidth = wrapper.clientWidth - 80; 
            const letterWidthInPx = 816; 
            
            if (availableWidth < letterWidthInPx) {
                const scale = availableWidth / letterWidthInPx;
                scaleWrapper.style.transform = `scale(${scale})`;
            } else {
                scaleWrapper.style.transform = `scale(1)`;
            }
        }
        window.addEventListener('resize', adjustScale);

        netlifyIdentity.on('init', checkAuth);
        netlifyIdentity.on('login', checkAuth);
        netlifyIdentity.on('logout', checkAuth);

        function checkAuth() {
            const user = netlifyIdentity.currentUser();
            if (user) {
                document.getElementById('login-wall').style.display = 'none';
                document.querySelector('.main-wrapper').style.display = 'flex';
                document.getElementById('user-name').innerText = user.user_metadata.full_name || user.email;
                initApp();
            } else {
                document.getElementById('login-wall').style.display = 'flex';
                document.querySelector('.main-wrapper').style.display = 'none';
            }
        }
        function logout() { netlifyIdentity.logout(); }

        async function initApp() {
            try {
                const response = await fetch('/data.json?t=' + new Date().getTime());
                if (response.ok) {
                    const json = await response.json();
                    cloudDataGlobal = json;

                    const datalist = document.getElementById('song-list-data');
                    datalist.innerHTML = "";
                    if (json.allSongs) {
                        json.allSongs.forEach(song => {
                            const option = document.createElement('option');
                            const prefix = song.n && song.n !== 'New' ? `#${song.n} - ` : '';
                            option.value = prefix + song.u;
                            datalist.appendChild(option);
                        });
                    }

                    const templateSelect = document.getElementById('cloud-templates');
                    templateSelect.innerHTML = '<option value="">-- Load Cloud Template --</option>';
                    if (json.cloudTemplates) {
                        json.cloudTemplates.forEach(t => {
                            templateSelect.innerHTML += `<option value="${t.name}">${t.name}</option>`;
                        });
                    }
                }
            } catch (e) { console.log("Fetch failed, running offline."); }

            const savedState = localStorage.getItem('fubc_studio_state');
            if (savedState) restoreState(JSON.parse(savedState));
            else loadDefault();
            
            new Sortable(document.getElementById('program-items'), { handle: '.drag-handle', animation: 150, onEnd: triggerUpdate });
            if(!document.getElementById('service-date').value) document.getElementById('service-date').valueAsDate = new Date();
            triggerUpdate();
            setTimeout(adjustScale, 100);
        }

        async function saveToCloud(action) {
            const user = netlifyIdentity.currentUser();
            if(!user) return alert("You must be logged in to sync to the cloud.");
            
            let templateName = null;
            if(action === 'template') {
                templateName = prompt("Enter a name for this Cloud Template:");
                if(!templateName) return;
            }

            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('debug-text').innerText = "Connecting to Database...";

            try {
                const token = await user.jwt();
                const res = await fetch('/.netlify/git/github/contents/data.json', { headers: { Authorization: `Bearer ${token}` }});
                if(!res.ok) throw new Error("Could not connect to GitHub Repo via Netlify API.");
                
                const fileInfo = await res.json();
                const contentStr = decodeURIComponent(escape(atob(fileInfo.content)));
                let dbData = JSON.parse(contentStr);

                const rows = [];
                document.querySelectorAll('.program-row').forEach(r => {
                    rows.push({ 
                        type: r.querySelector('.type-input').value.trim(), 
                        desc: r.querySelector('.desc-input').value.trim(),
                        dur: r.querySelector('.duration-input').value.trim()
                    });
                });

                if (action === 'publish') {
                    dbData.serviceProgram = {
                        date: document.getElementById('service-date').value,
                        isVisible: true,
                        items: rows
                    };
                } else if (action === 'template') {
                    if(!dbData.cloudTemplates) dbData.cloudTemplates = [];
                    const existingIndex = dbData.cloudTemplates.findIndex(t => t.name === templateName);
                    const newTemp = { name: templateName, items: rows };
                    
                    if(existingIndex > -1) dbData.cloudTemplates[existingIndex] = newTemp;
                    else dbData.cloudTemplates.push(newTemp);
                }

                document.getElementById('debug-text').innerText = "Saving data to cloud...";
                const newContentBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(dbData, null, 2))));
                
                const putRes = await fetch('/.netlify/git/github/contents/data.json', {
                    method: 'PUT',
                    headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: action === 'publish' ? `[Studio] Published Service Program for ${document.getElementById('service-date').value}` : `[Studio] Saved Cloud Template: ${templateName}`,
                        content: newContentBase64,
                        sha: fileInfo.sha,
                        branch: "main" 
                    })
                });

                if(!putRes.ok) throw new Error("Database write rejected.");
                
                alert("Cloud Sync Successful! Changes are live.");
                initApp(); 

            } catch(e) {
                console.error(e);
                alert("Cloud Sync Failed: " + e.message);
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        function loadCloudTemplate() {
            const tName = document.getElementById('cloud-templates').value;
            if(!tName || !cloudDataGlobal || !cloudDataGlobal.cloudTemplates) return;
            
            const template = cloudDataGlobal.cloudTemplates.find(t => t.name === tName);
            if(template && template.items) {
                document.getElementById('program-items').innerHTML = "";
                template.items.forEach(i => addProgramRow(i.type, i.desc, i.dur));
                triggerUpdate();
            }
        }

        async function handlePdfImport(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                document.getElementById('loading-overlay').style.display = 'flex';
                document.getElementById('debug-text').innerText = "Analyzing PDF Structure...";

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    const page = await pdf.getPage(1);
                    const textContent = await page.getTextContent();
                    
                    if (textContent.items.length === 0) {
                        alert("Error: No readable text found. This PDF appears to be a scanned image.");
                        return;
                    }

                    const items = textContent.items.map(i => ({ str: i.str, y: i.transform[5], x: i.transform[4] })).sort((a, b) => {
                        if (Math.abs(a.y - b.y) > 20) return b.y - a.y; 
                        return a.x - b.x;
                    });

                    let lines = [];
                    let currentLine = "";
                    let lastY = -1;

                    items.forEach(item => {
                        let text = item.str.trim();
                        if (!text) return;
                        
                        if (lastY !== -1 && Math.abs(item.y - lastY) > 20) {
                            if (currentLine) lines.push(currentLine.trim());
                            currentLine = text;
                        } else {
                            currentLine += " " + text;
                        }
                        lastY = item.y;
                    });
                    if (currentLine) lines.push(currentLine.trim());

                    document.getElementById('program-items').innerHTML = ""; 

                    for (let line of lines) {
                        line = line.replace(/\s+/g, ' ').trim();
                        if(!line) continue;
                        
                        const dateMatch = line.match(/(\d{1,2})[\/\.](\d{1,2})[\/\.](\d{4})/);
                        if (dateMatch) {
                            const y = dateMatch[3]; const m = dateMatch[1].padStart(2, '0'); const d = dateMatch[2].padStart(2, '0');
                            document.getElementById('service-date').value = `${y}-${m}-${d}`;
                            continue;
                        }

                        let lowerLine = line.toLowerCase();
                        if (lowerLine.includes("–ø—Ä–æ–≥—Ä–∞–º–∞") || lowerLine.includes("page")) continue;

                        let matchedType = "";
                        let desc = line;
                        let dur = "5"; 

                        if (lowerLine.includes("–æ—Ä–∫–µ—Å—Ç—Ä")) { matchedType = "–î—É—Ö. –û—Ä–∫–µ—Å—Ç—Ä:"; dur = "10"; }
                        else if (lowerLine.includes("–∑–∞–≥") && lowerLine.includes("—Å–ø—ñ–≤")) { matchedType = "–ó–∞–≥. –°–ø—ñ–≤:"; }
                        else if (lowerLine.includes("–ø—Ä–æ–ø–æ–≤—ñ–¥—å") || lowerLine.includes("—Å–ª–æ–≤–æ")) { matchedType = "–ü—Ä–æ–ø–æ–≤—ñ–¥—å"; dur = "30"; }
                        else if (lowerLine.includes("—É—á–∞—Å—Ç—å") || lowerLine.includes("–≥—É—Ä—Ç") || lowerLine.includes("—Ö–æ—Ä")) { matchedType = "–£—á–∞—Å—Ç—å:"; }
                        else if (lowerLine.includes("–∑–∞–∫–ª—é—á–Ω–∞") && lowerLine.includes("–º–æ–ª–∏—Ç–≤–∞")) { matchedType = "–ó–∞–∫–ª—é—á–Ω–∞ –º–æ–ª–∏—Ç–≤–∞"; dur = "3"; }
                        else if (lowerLine.includes("—É–∫—Ä–∞—ó–Ω—É") && lowerLine.includes("–º–æ–ª–∏—Ç–≤–∞")) { matchedType = "–ú–æ–ª–∏—Ç–≤–∞ –∑–∞ –£–∫—Ä–∞—ó–Ω—É"; }
                        else if (lowerLine.includes("–ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è") || lowerLine.includes("–º–æ–ª–∏—Ç–≤–∞")) { matchedType = "–ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è/–ú–æ–ª–∏—Ç–≤–∞"; }
                        else if (lowerLine.includes("–æ–≥–æ–ª–æ—à–µ–Ω–Ω—è")) { matchedType = "–û–≥–æ–ª–æ—à–µ–Ω–Ω—è"; dur = "3"; }

                        if (matchedType) {
                            let cleanDesc = line;
                            const prefixesToRemove = ["–î—É—Ö. –û—Ä–∫–µ—Å—Ç—Ä:", "–ó–∞–≥. –°–ø—ñ–≤:", "–ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è/–ú–æ–ª–∏—Ç–≤–∞", "–ü—Ä–æ–ø–æ–≤—ñ–¥—å", "–£—á–∞—Å—Ç—å:", "–ú–æ–ª–∏—Ç–≤–∞ –∑–∞ –£–∫—Ä–∞—ó–Ω—É", "–ó–∞–∫–ª—é—á–Ω–∞ –º–æ–ª–∏—Ç–≤–∞", "–û–≥–æ–ª–æ—à–µ–Ω–Ω—è"];
                            
                            for (let prefix of prefixesToRemove) {
                                if (cleanDesc.toLowerCase().startsWith(prefix.toLowerCase())) {
                                    cleanDesc = cleanDesc.substring(prefix.length).trim();
                                    if(cleanDesc.startsWith(':') || cleanDesc.startsWith('-')) cleanDesc = cleanDesc.substring(1).trim();
                                    break;
                                }
                            }
                            addProgramRow(matchedType, cleanDesc, dur);
                        } else if (line.length > 2) {
                            addProgramRow("", line, "2");
                        }
                    }
                    
                    triggerUpdate();
                    alert("Import Complete! Please verify the parsed rows.");

                } catch (e) {
                    console.error(e);
                    alert("Error reading PDF: " + e.message);
                } finally {
                    document.getElementById('loading-overlay').style.display = 'none';
                    input.value = '';
                }
            }
        }

        function addProgramRow(type = "–î—É—Ö. –û—Ä–∫–µ—Å—Ç—Ä:", desc = "", dur = "") {
            const container = document.getElementById('program-items');
            const row = document.createElement('div');
            row.className = 'program-row';
            row.innerHTML = `
                <span class="drag-handle">‚ò∞</span>
                <input type="text" class="type-input" list="item-types-list" value="${type}" placeholder="Type (Bold)..." oninput="triggerUpdate()">
                <input type="text" class="desc-input" list="song-list-data" value="${desc}" placeholder="Description / Song..." oninput="triggerUpdate()">
                <input type="number" class="duration-input" value="${dur}" placeholder="min" min="0" oninput="triggerUpdate()">
                <button class="delete-btn" onclick="this.parentElement.remove(); triggerUpdate()">√ó</button>
            `;
            container.appendChild(row);
            triggerUpdate();
        }

        function triggerUpdate() {
            const d = new Date(document.getElementById('service-date').value);
            d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
            document.getElementById('preview-date').innerText = d && !isNaN(d) ? `${d.getMonth() + 1}/${d.getDate()}/${d.getFullYear()}` : '...';

            const container = document.getElementById('pdf-preview-container');
            container.style.fontSize = `${document.getElementById('font-size').value}pt`;
            const content = document.getElementById('preview-content');
            content.innerHTML = "";
            const spacing = document.getElementById('line-spacing').value;

            let totalMinutes = 0;

            document.querySelectorAll('.program-row').forEach(row => {
                let typeVal = row.querySelector('.type-input').value.trim();
                let descVal = row.querySelector('.desc-input').value.trim();
                let durVal = parseInt(row.querySelector('.duration-input').value) || 0;
                totalMinutes += durVal;

                if (typeVal.endsWith(':') && descVal === "") typeVal = typeVal.slice(0, -1);
                let html = typeVal === "" ? `<span class="preview-desc">${descVal}</span>` : `<span class="preview-type">${typeVal}</span> <span class="preview-desc">${descVal}</span>`;
                content.innerHTML += `<div class="preview-item" style="line-height: ${spacing}">${html}</div>`;
            });

            document.getElementById('total-min').innerText = totalMinutes;
            const startTimeVal = document.getElementById('start-time').value;
            if (startTimeVal) {
                const [hours, mins] = startTimeVal.split(':').map(Number);
                const endDate = new Date(); endDate.setHours(hours, mins, 0, 0); endDate.setMinutes(endDate.getMinutes() + totalMinutes);
                document.getElementById('est-end').innerText = endDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            saveState();
        }

        function saveState() {
            const rows = [];
            document.querySelectorAll('.program-row').forEach(r => { rows.push({ type: r.querySelector('.type-input').value, desc: r.querySelector('.desc-input').value, dur: r.querySelector('.duration-input').value }); });
            localStorage.setItem('fubc_studio_state', JSON.stringify({ date: document.getElementById('service-date').value, startTime: document.getElementById('start-time').value, fontSize: document.getElementById('font-size').value, items: rows }));
        }

        function restoreState(state) {
            document.getElementById('service-date').value = state.date || '';
            document.getElementById('start-time').value = state.startTime || '09:00';
            document.getElementById('font-size').value = state.fontSize || 22;
            document.getElementById('program-items').innerHTML = "";
            if (state.items) state.items.forEach(i => addProgramRow(i.type, i.desc, i.dur));
            triggerUpdate();
        }

        function loadDefault() {
            document.getElementById('program-items').innerHTML = "";
            addProgramRow("–î—É—Ö. –û—Ä–∫–µ—Å—Ç—Ä:", "", "10"); addProgramRow("–ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è/–ú–æ–ª–∏—Ç–≤–∞", "", "5"); addProgramRow("–ó–∞–≥. –°–ø—ñ–≤:", "", "5"); addProgramRow("–ü—Ä–æ–ø–æ–≤—ñ–¥—å", "", "30"); addProgramRow("–£—á–∞—Å—Ç—å:", "", "5"); addProgramRow("–ó–∞–∫–ª—é—á–Ω–∞ –º–æ–ª–∏—Ç–≤–∞", "", "5");
            triggerUpdate();
        }

        function generatePDF() {
            const element = document.getElementById('pdf-preview-container');
            const scaleWrapper = document.getElementById('scale-wrapper');
            const originalTransform = scaleWrapper.style.transform;
            scaleWrapper.style.transform = 'scale(1)';

            const dateStr = document.getElementById('preview-date').innerText.replace(/\//g, '-');
            const opt = { 
                margin: 0, 
                filename: `Program_${dateStr}.pdf`, 
                image: { type: 'jpeg', quality: 1 }, 
                html2canvas: { scale: 2, useCORS: true }, 
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } 
            };
            
            html2pdf().set(opt).from(element).save().then(() => {
                scaleWrapper.style.transform = originalTransform;
            });
        }

        function shareToViber() {
            let text = `–ü—Ä–æ–≥—Ä–∞–º–∞ —Å–ª—É–∂—ñ–Ω–Ω—è - ${document.getElementById('preview-date').innerText}\n\n`;
            document.querySelectorAll('.program-row').forEach(row => {
                const type = row.querySelector('.type-input').value.trim();
                const desc = row.querySelector('.desc-input').value.trim();
                if(type !== "") text += `${type} ${desc}\n`; else text += `${desc}\n`;
            });
            navigator.clipboard.writeText(text).then(() => {
                alert("Text copied to clipboard! You can now paste it into Viber.");
            });
        }
    </script>
</body>
</html>
