<!DOCTYPE html>
<html lang="en" class="scroll-smooth bg-[#f8fafc]">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Instrumental Music School | FUBC Band</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.2.2/dist/abcjs-basic-min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <link rel="icon" type="image/png" href="/social-logo.png?v=2">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], heading: ['Montserrat', 'sans-serif'] },
                    colors: { pageBg: '#f8fafc', textMain: '#0f172a', textMuted: '#64748b', brass: '#b45309', brassLight: '#d97706', surface: '#ffffff' },
                    animation: { 
                        'fade-in-up': 'fadeInUp 0.6s ease-out forwards',
                        'marquee-mobile': 'marquee 25s linear infinite',
                        'marquee-desktop': 'marquee 45s linear infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    },
                    keyframes: {
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        marquee: { '0%': { transform: 'translateX(0%)' }, '100%': { transform: 'translateX(-100%)' } }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #b45309; margin-top: -10px; cursor: pointer; border: 2px solid white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 99px; }
        
        #print-staves { display: none; }
        @media print { body > *:not(#print-staves) { display: none !important; } #print-staves { display: block !important; background: white; width: 100%; } .stave { border-bottom: 1px solid black; margin-bottom: 8px; height: 1px; width: 100%; } .stave-group { margin-bottom: 40px; } @page { margin: 0.5in; } }
        .hero-bg { background-image: url('https://images.unsplash.com/photo-1573871669414-010dbf73ca84?q=80&w=2071&auto=format&fit=crop'); background-size: cover; background-position: center; }
        .abcjs-container svg { max-width: 100%; height: auto; border-radius: 0.5rem; }
    </style>
</head>

<body class="text-textMain antialiased bg-pageBg overflow-x-hidden" x-data="schoolApp" @scroll.window="scrollY = window.pageYOffset; scrollProgress = (window.pageYOffset / (document.documentElement.scrollHeight - window.innerHeight)) * 100">

    <div class="fixed top-0 left-0 h-1.5 bg-gradient-to-r from-brass to-brassLight z-[100] shadow-md transition-all duration-150 ease-linear" :style="'width: ' + scrollProgress + '%'"></div>
    <div id="print-staves"></div>

    <div x-show="fullScreenModalOpen" x-transition.opacity class="fixed inset-0 z-[110] flex items-center justify-center bg-slate-900/90 backdrop-blur-md p-4 w-full h-full" x-cloak>
        <div @click.away="fullScreenModalOpen = false" class="bg-white rounded-2xl w-full max-w-5xl h-full max-h-[90vh] flex flex-col shadow-2xl overflow-hidden relative">
            <div class="flex justify-between items-center p-4 sm:p-6 border-b border-slate-100 bg-slate-50 flex-shrink-0">
                <h3 class="font-heading text-lg sm:text-xl font-bold text-slate-900 uppercase tracking-widest truncate mr-4">
                    <span x-show="lang === 'en'" x-text="exercises[currentFullScreenIdx].title_en"></span>
                    <span x-show="lang === 'ua'" x-text="exercises[currentFullScreenIdx].title_ua"></span>
                </h3>
                <button @click="fullScreenModalOpen = false" class="text-slate-400 hover:text-brass transition-colors focus:outline-none p-2 rounded-full hover:bg-slate-200 flex-shrink-0">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-4 sm:p-8 flex-grow overflow-auto bg-white flex items-start sm:items-center justify-center relative w-full">
                <div id="abc-fullscreen" class="w-full"></div>
            </div>
        </div>
    </div>

    <div class="w-full max-w-[100vw] bg-slate-900 text-white py-2.5 overflow-hidden relative z-50 border-b border-brass/20 flex flex-nowrap">
        <div class="whitespace-nowrap animate-marquee-mobile md:animate-marquee-desktop flex items-center min-w-full shrink-0">
            <span class="px-8 text-brassLight font-bold uppercase tracking-wider text-xs sm:text-base"><span x-show="lang === 'en'">Instrumental Music School</span><span x-show="lang === 'ua'" x-cloak>Інструментальна Школа</span></span>
            <span class="px-8 text-slate-400 italic font-serif text-sm sm:text-lg"><span x-show="lang === 'en'">Equipping the next generation of musicians...</span><span x-show="lang === 'ua'" x-cloak>Підготовка нового покоління музикантів...</span></span>
            <span class="px-8 text-brassLight font-bold uppercase tracking-wider text-xs sm:text-base"><span x-show="lang === 'en'">Instrumental Music School</span><span x-show="lang === 'ua'" x-cloak>Інструментальна Школа</span></span>
            <span class="px-8"></span> 
        </div>
        <div class="whitespace-nowrap animate-marquee-mobile md:animate-marquee-desktop flex items-center min-w-full shrink-0">
            <span class="px-8 text-brassLight font-bold uppercase tracking-wider text-xs sm:text-base"><span x-show="lang === 'en'">Instrumental Music School</span><span x-show="lang === 'ua'" x-cloak>Інструментальна Школа</span></span>
            <span class="px-8 text-slate-400 italic font-serif text-sm sm:text-lg"><span x-show="lang === 'en'">Equipping the next generation of musicians...</span><span x-show="lang === 'ua'" x-cloak>Підготовка нового покоління музикантів...</span></span>
            <span class="px-8 text-brassLight font-bold uppercase tracking-wider text-xs sm:text-base"><span x-show="lang === 'en'">Instrumental Music School</span><span x-show="lang === 'ua'" x-cloak>Інструментальна Школа</span></span>
            <span class="px-8"></span> 
        </div>
    </div>

    <nav class="sticky top-0 z-40 bg-slate-100/95 backdrop-blur-md border-b border-slate-200/80 shadow-sm transition-colors duration-300 w-full max-w-[100vw]" :class="mobileMenuOpen ? 'bg-slate-100 border-transparent' : ''">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative w-full">
            <div class="flex justify-between items-center h-16 w-full">
                <a href="#" class="flex items-center gap-2 sm:gap-3 hover:opacity-80 transition-opacity group z-50 relative shrink-0">
                    <div class="font-heading font-bold text-lg sm:text-xl md:text-2xl tracking-[0.1em] sm:tracking-[0.15em] text-slate-900 leading-none">
                        FUBC <span class="text-brass block text-[9px] sm:text-[10px] md:text-xs font-semibold tracking-[0.2em] sm:tracking-[0.35em] mt-0.5 group-hover:text-brassLight transition-colors">MUSIC SCHOOL</span>
                    </div>
                </a>
                
                <div class="md:hidden flex items-center gap-2 sm:gap-4 relative z-50 shrink-0">
                    <button @click="lang = lang === 'en' ? 'ua' : 'en'; $nextTick(() => renderWarmups());" class="text-[10px] font-bold text-slate-500 hover:text-slate-900 transition-colors uppercase tracking-widest border border-slate-200 px-2.5 py-1.5 rounded-full bg-slate-50 flex-shrink-0">
                        <span :class="lang === 'en' ? 'text-brass font-extrabold' : ''">EN</span><span class="text-slate-300 px-1">/</span><span :class="lang === 'ua' ? 'text-brass font-extrabold' : ''">UA</span>
                    </button>
                    <button @click="mobileMenuOpen = !mobileMenuOpen" class="p-2 text-slate-800 hover:text-brass transition-colors focus:outline-none flex-shrink-0">
                        <svg x-show="!mobileMenuOpen" class="w-6 h-6 sm:w-7 sm:h-7 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
                        <svg x-show="mobileMenuOpen" class="w-6 h-6 sm:w-7 sm:h-7 transform transition-transform duration-300 rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" x-cloak><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>

                <div class="hidden md:flex items-center gap-6 relative z-50 shrink-0">
                    <button @click="lang = lang === 'en' ? 'ua' : 'en'; $nextTick(() => renderWarmups());" class="text-xs font-bold text-slate-500 hover:text-slate-900 transition-colors uppercase tracking-widest border border-slate-200 px-4 py-1.5 rounded-full hover:border-brass/50 bg-slate-50 transition-all duration-200 hover:shadow-sm">
                        <span :class="lang === 'en' ? 'text-brass font-extrabold' : ''">EN</span> <span class="text-slate-300 px-1">/</span> <span :class="lang === 'ua' ? 'text-brass font-extrabold' : ''">UA</span>
                    </button>
                    <a href="#warmups" class="font-bold text-xs uppercase tracking-widest text-slate-500 hover:text-brass transition-colors"><span x-show="lang === 'en'">Warm-Ups</span><span x-show="lang === 'ua'" x-cloak>Розминка</span></a>
                    <a href="#setlist" class="font-bold text-xs uppercase tracking-widest text-slate-500 hover:text-brass transition-colors"><span x-show="lang === 'en'">Practice</span><span x-show="lang === 'ua'" x-cloak>Заняття</span></a>
                    <a href="#tools-resources" class="font-bold text-xs uppercase tracking-widest text-slate-500 hover:text-brass transition-colors"><span x-show="lang === 'en'">Tools & Resources</span><span x-show="lang === 'ua'" x-cloak>Інструменти</span></a>
                    <a href="/" class="text-xs font-bold text-white bg-slate-900 px-5 py-2 rounded-full hover:bg-brass transition-all duration-300 transform hover:-translate-y-0.5 hover:shadow-md uppercase tracking-widest"><span x-show="lang === 'en'">Main Band</span><span x-show="lang === 'ua'" x-cloak>Оркестр</span></a>
                </div>
            </div>
            
            <div class="absolute top-full left-0 w-full h-auto bg-slate-100 border-b-4 border-brass shadow-2xl md:hidden flex flex-col px-6 pb-6 transition-all duration-300 origin-top z-30" x-show="mobileMenuOpen" x-transition:enter="opacity-0 scale-y-0" x-transition:enter-end="opacity-100 scale-y-100" x-transition:leave="opacity-100 scale-y-100" x-transition:leave-end="opacity-0 scale-y-0" x-cloak>
                <div class="flex flex-col items-center justify-center space-y-5 mt-6">
                    <a href="#warmups" @click="mobileMenuOpen = false" class="text-xl font-heading font-bold text-slate-800 hover:text-brass transition-colors uppercase tracking-widest"><span x-show="lang === 'en'">Warm-Ups</span><span x-show="lang === 'ua'" x-cloak>Розминка</span></a>
                    <a href="#setlist" @click="mobileMenuOpen = false" class="text-xl font-heading font-bold text-slate-800 hover:text-brass transition-colors uppercase tracking-widest"><span x-show="lang === 'en'">Practice</span><span x-show="lang === 'ua'" x-cloak>Заняття</span></a>
                    <a href="#tools-resources" @click="mobileMenuOpen = false" class="text-xl font-heading font-bold text-slate-800 hover:text-brass transition-colors uppercase tracking-widest"><span x-show="lang === 'en'">Tools & Resources</span><span x-show="lang === 'ua'" x-cloak>Інструменти</span></a>
                    <div class="w-full h-px bg-slate-200 my-2"></div>
                    <a href="/" class="text-sm font-bold text-white bg-slate-900 px-8 py-3 rounded-full hover:bg-brass transition-colors uppercase tracking-widest shadow-sm"><span x-show="lang === 'en'">Main Band Site</span><span x-show="lang === 'ua'" x-cloak>Головний сайт</span></a>
                </div>
            </div>
        </div>
    </nav>

    <div class="relative w-full max-w-[100vw] h-[500px] sm:h-[600px] bg-slate-900 overflow-hidden">
        <img src="https://images.unsplash.com/photo-1573871669414-010dbf73ca84?q=80&w=2071&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-40 will-change-transform" :style="'transform: translateY(' + (scrollY * 0.4) + 'px)'" alt="Brass Instruments">
        <div class="absolute inset-0 bg-gradient-to-b from-slate-900/60 via-slate-900/30 to-slate-900"></div>
        <div class="absolute inset-0 flex flex-col items-center justify-center text-center px-4 pt-4 sm:pt-10 z-10 animate-fade-in-up">
            <h1 class="font-heading text-xl sm:text-4xl md:text-5xl font-bold text-white tracking-tight mb-6 drop-shadow-2xl max-w-4xl mx-auto leading-snug px-2">
                <span x-show="lang === 'en'">“Sing to him a new song; play skillfully on the strings, with loud shouts.”<br><span class="text-sm sm:text-2xl font-medium mt-4 block text-brassLight tracking-wider">– Psalm 33:3</span></span>
                <span x-show="lang === 'ua'" x-cloak>“Співайте Йому нову пісню, гарно грайте на струнах з гуком!”<br><span class="text-sm sm:text-2xl font-medium mt-4 block text-brassLight tracking-wider">– Псалми 33:3</span></span>
            </h1>
            <p class="text-slate-300 text-xs sm:text-lg max-w-2xl font-light tracking-wide uppercase">
                <span x-show="lang === 'en'">Instrumental Music School</span>
                <span x-show="lang === 'ua'" x-cloak>Інструментальна Школа</span>
            </p>
        </div>
        <div class="absolute bottom-0 left-0 w-full overflow-hidden leading-[0] z-20 pointer-events-none">
            <svg class="relative block w-full h-[40px] sm:h-[100px]" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none"><path d="M985.66,92.83C906.67,72,823.78,31,743.84,14.19c-82.26-17.34-168.06-16.33-250.45.39-57.84,11.73-114,31.07-172,41.86A600.21,600.21,0,0,1,0,27.35V120H1200V95.8C1132.19,118.92,1055.71,111.31,985.66,92.83Z" class="fill-[#f8fafc]"></path></svg>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12 space-y-8 sm:space-y-12 relative z-30 -mt-10 sm:-mt-16 pointer-events-auto w-full">

        <div class="bg-gradient-to-r from-slate-900 to-slate-800 rounded-2xl shadow-xl border border-slate-700 p-5 sm:p-6 flex flex-col sm:flex-row items-center justify-between gap-4 sm:gap-6 relative z-20 animate-fade-in-up" style="animation-delay: 0.1s;">
            <div class="flex items-center gap-4 text-center sm:text-left w-full sm:w-auto justify-center sm:justify-start">
                <div class="p-3 bg-brass/20 rounded-full hidden md:block shrink-0">
                    <svg class="w-8 h-8 text-brassLight" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg>
                </div>
                <div>
                    <h2 class="text-white font-bold text-lg sm:text-xl font-heading tracking-wide">
                        <span x-show="lang === 'en'">Select Your Instrument</span>
                        <span x-show="lang === 'ua'" x-cloak>Оберіть Ваш Інструмент</span>
                    </h2>
                    <p class="text-slate-400 text-xs sm:text-sm mt-1">
                        <span x-show="lang === 'en'">Sheet music and tools will automatically adjust to you.</span>
                        <span x-show="lang === 'ua'" x-cloak>Ноти та інструменти автоматично підлаштуються під вас.</span>
                    </p>
                </div>
            </div>
            <div class="relative w-full sm:w-72 shrink-0">
                <select x-model="globalInstrument" @change="updateGlobalInstrument($event.target.value)" class="w-full bg-slate-800 text-white border-2 border-slate-600 rounded-xl px-4 py-3 sm:px-5 sm:py-3.5 text-base sm:text-lg font-bold focus:outline-none focus:border-brass transition-colors cursor-pointer appearance-none shadow-inner">
                    <template x-for="inst in availableInstruments" :key="inst">
                        <option :value="inst" x-text="inst"></option>
                    </template>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none">
                    <svg class="w-5 h-5 text-brass" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8 animate-fade-in-up" style="animation-delay: 0.2s;">
            <div class="bg-white rounded-2xl shadow-md border border-slate-200 p-5 sm:p-6 flex flex-col md:flex-row items-center justify-between relative overflow-hidden transition-all duration-300 hover:shadow-lg">
                <div class="flex items-center gap-4 sm:gap-6 relative z-10 w-full mb-4 md:mb-0 justify-center md:justify-start">
                    <div class="w-12 h-12 sm:w-16 sm:h-16 bg-brass/10 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 sm:w-8 sm:h-8 text-brass" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" /><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z" /></svg>
                    </div>
                    <div class="text-center md:text-left">
                        <h3 class="font-heading font-bold text-slate-900 text-base sm:text-lg">
                            <span x-show="lang === 'en'">Practice Streak</span><span x-show="lang === 'ua'" x-cloak>Дні занять поспіль</span>
                        </h3>
                        <div class="text-2xl sm:text-3xl font-black text-slate-900 leading-tight">
                            <span x-text="streak"></span> <span class="text-sm sm:text-base text-slate-400 font-medium"><span x-show="lang === 'en'">days</span><span x-show="lang === 'ua'" x-cloak>днів</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-md border border-slate-200 p-5 sm:p-6 flex flex-col justify-center relative overflow-hidden transition-all duration-300 hover:shadow-lg">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-heading font-bold text-slate-900 text-base sm:text-lg">
                        <span x-show="lang === 'en'">Guided Session</span><span x-show="lang === 'ua'" x-cloak>Таймер Занять</span>
                    </h3>
                    <span class="text-[10px] font-bold text-brass bg-brass/10 px-2 py-1 rounded uppercase tracking-widest" x-text="sessionPhases[sessionPhase].name"></span>
                </div>
                <div class="flex items-center justify-between">
                    <div class="text-4xl font-mono font-black text-slate-900 tracking-tight" x-text="formatTime(sessionTimeLeft)">25:00</div>
                    <div class="flex gap-2">
                        <button @click="toggleSession()" class="bg-slate-900 text-white px-6 py-2 rounded-lg font-bold text-sm uppercase tracking-widest hover:bg-brass transition-colors shadow-sm" x-text="sessionActive ? (lang === 'en' ? 'Pause' : 'Пауза') : (lang === 'en' ? 'Start' : 'Старт')"></button>
                        <button @click="resetSession()" class="bg-slate-100 text-slate-500 px-4 py-2 rounded-lg font-bold text-sm hover:bg-slate-200 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        </button>
                    </div>
                </div>
                <div class="w-full bg-slate-100 h-1.5 rounded-full mt-4 overflow-hidden">
                    <div class="bg-brass h-full transition-all duration-1000" :style="`width: ${(1 - sessionTimeLeft / sessionPhases[sessionPhase].duration) * 100}%`"></div>
                </div>
            </div>
        </div>

        <section id="warmups" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden scroll-mt-24 transition-all duration-300 hover:shadow-md animate-fade-in-up" style="animation-delay: 0.3s;">
            <div class="px-5 sm:px-6 py-5 sm:py-6 border-b border-slate-100 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div>
                    <h2 class="font-heading text-xl font-bold text-slate-900">
                        <span x-show="lang === 'en'">Daily Warm-Ups</span><span x-show="lang === 'ua'" x-cloak>Щоденна Розминка</span>
                    </h2>
                    <p class="text-xs text-slate-500 mt-1">
                        <span x-show="lang === 'en'">Press play to hear the synth track, or click to expand.</span>
                        <span x-show="lang === 'ua'" x-cloak>Натисніть Play щоб почути, або клікніть для розгортання.</span>
                    </p>
                </div>
                <div class="flex items-center justify-center gap-2 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200">
                    <span class="text-[10px] sm:text-xs text-slate-500 font-bold uppercase tracking-wider"><span x-show="lang === 'en'">Key:</span><span x-show="lang === 'ua'" x-cloak>Ключ:</span></span>
                    <span class="text-xs sm:text-sm text-brass font-black uppercase tracking-wide" x-text="instrumentGroups[selectedGroup].key + ' Major'"></span>
                </div>
            </div>
            
            <div class="p-4 sm:p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 bg-slate-50/50">
                <template x-for="(ex, index) in exercises" :key="index">
                    <div class="bg-white rounded-xl border border-slate-200 p-4 sm:p-5 shadow-sm transform transition-all hover:-translate-y-1 hover:border-brass hover:shadow-md relative flex flex-col overflow-hidden">
                        <div class="flex justify-between items-center mb-3 border-b border-slate-100 pb-2">
                            <h3 class="font-heading text-xs sm:text-sm font-bold text-slate-900 uppercase tracking-widest truncate pr-2 cursor-pointer hover:text-brass" @click="openFullScreen(index)">
                                <span x-show="lang === 'en'" x-text="ex.title_en"></span>
                                <span x-show="lang === 'ua'" x-cloak x-text="ex.title_ua"></span>
                            </h3>
                            
                            <button @click="playExerciseAudio(index)" class="bg-brass/10 hover:bg-brass text-brass hover:text-white p-1.5 rounded-lg transition-colors flex-shrink-0 focus:outline-none" :class="playingExerciseIdx === index ? 'bg-red-500 text-white animate-pulse' : ''">
                                <svg x-show="playingExerciseIdx !== index" class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                <svg x-show="playingExerciseIdx === index" class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" x-cloak><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                            </button>
                        </div>
                        <div @click="openFullScreen(index)" class="w-full overflow-x-auto min-h-[60px] sm:min-h-[80px] pointer-events-none flex items-center justify-start sm:justify-center cursor-pointer">
                            <div :id="'abc-warmup-' + index" class="w-full min-w-min"></div>
                        </div>
                    </div>
                </template>
            </div>
        </section>

        <section id="setlist" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden scroll-mt-24 transition-all duration-300 hover:shadow-md animate-fade-in-up" style="animation-delay: 0.4s;">
            <div class="px-5 sm:px-6 py-5 sm:py-6 border-b border-slate-100 flex items-center justify-between">
                <h2 class="font-heading text-xl font-bold text-slate-900">
                    <span x-show="lang === 'en'">Current Repertoire</span><span x-show="lang === 'ua'" x-cloak>Поточний Репертуар</span>
                </h2>
                <span class="text-[10px] sm:text-xs font-bold bg-brass/10 text-brass px-2 sm:px-3 py-1 rounded-full uppercase tracking-wider" x-text="schoolSongs.length + (lang === 'en' ? ' Songs' : ' Пісень')"></span>
            </div>
            
            <div class="p-4 sm:p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 bg-slate-50/50">
                <template x-for="song in schoolSongs" :key="song.title">
                    <div class="bg-white rounded-xl border border-slate-200 p-4 sm:p-5 shadow-sm hover:shadow-md hover:border-brass transition-all duration-300 transform hover:-translate-y-1 flex flex-col group">
                        <div class="text-[9px] sm:text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2"><span x-show="lang === 'en'">Sheet Music</span><span x-show="lang === 'ua'" x-cloak>Ноти</span></div>
                        <h3 class="font-heading text-base sm:text-lg font-bold text-slate-900 mb-1 group-hover:text-brass transition-colors" x-text="song.title"></h3>
                        <p class="text-slate-500 text-xs sm:text-sm mb-4 flex-grow" x-text="lang === 'en' ? song.desc_en : song.desc_ua"></p>
                        <a :href="song.link" target="_blank" class="mt-auto text-[10px] sm:text-xs font-bold text-brass hover:text-brassLight flex items-center gap-1">
                            <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                            <span x-show="lang === 'en'">Open Music</span><span x-show="lang === 'ua'" x-cloak>Відкрити</span>
                        </a>
                    </div>
                </template>
            </div>
        </section>

        <section id="submission" class="bg-slate-900 rounded-2xl shadow-lg border border-slate-800 overflow-hidden relative transition-all duration-300 hover:shadow-xl animate-fade-in-up" style="animation-delay: 0.5s;">
            <div class="absolute top-0 right-0 p-32 bg-brass/10 blur-3xl rounded-full pointer-events-none"></div>
            <div x-show="submitStatus === 'success'" class="absolute inset-0 z-20 bg-emerald-600 flex flex-col items-center justify-center text-center p-6" x-transition><svg class="w-16 h-16 text-white mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h3 class="text-2xl font-bold text-white"><span x-show="lang === 'en'">Submitted Successfully!</span><span x-show="lang === 'ua'" x-cloak>Успішно надіслано!</span></h3></div>
            
            <div class="p-6 sm:p-8 relative z-10 grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div>
                    <span class="inline-block px-3 py-1 bg-brass/20 text-brassLight text-[10px] font-extrabold uppercase tracking-widest rounded-full mb-4">Beta</span>
                    <h3 class="font-heading text-2xl sm:text-3xl font-bold text-white mb-2"><span x-show="lang === 'en'">Playing Test Submissions</span><span x-show="lang === 'ua'" x-cloak>Здача Партій</span></h3>
                    <p class="text-slate-400 text-sm leading-relaxed mb-6"><span x-show="lang === 'en'">Record your assigned piece or scale and upload it directly for feedback from the conductor. Please include your instrument and song name.</span><span x-show="lang === 'ua'" x-cloak>Запишіть задану п'єсу або гамму та завантажте сюди для перевірки диригентом.</span></p>
                </div>
                
                <form x-ref="testForm" @submit.prevent="submitTest" name="playing_test" method="POST" data-netlify="true" enctype="multipart/form-data" class="bg-slate-800/50 border border-slate-700 p-5 rounded-xl space-y-4">
                    <input type="hidden" name="form-name" value="playing_test" />
                    <input type="text" name="name" required :placeholder="lang === 'en' ? 'Student Name' : 'Ім\'я Учня'" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-brass transition-colors">
                    <input type="text" name="song" required :placeholder="lang === 'en' ? 'Song / Scale Name' : 'Назва твору / гамми'" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-brass transition-colors">
                    <div class="relative w-full">
                        <input type="file" name="recording" accept="audio/*,video/*" required class="block w-full text-sm text-slate-400 file:mr-4 file:py-2.5 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-bold file:bg-slate-700 file:text-white hover:file:bg-slate-600 focus:outline-none cursor-pointer bg-slate-900 border border-slate-700 rounded-lg pr-4">
                    </div>
                    <button type="submit" class="w-full bg-brass hover:bg-brassLight text-white font-bold text-sm py-3.5 rounded-lg transition-colors shadow-lg disabled:opacity-50" :disabled="submitStatus === 'submitting'"><span x-show="submitStatus === 'idle'"><span x-show="lang === 'en'">Upload Recording</span><span x-show="lang === 'ua'" x-cloak>Завантажити Запис</span></span><span x-show="submitStatus === 'submitting'">Uploading...</span></button>
                </form>
            </div>
        </section>

        <section id="tools-resources" class="scroll-mt-24 transition-all duration-300 animate-fade-in-up" style="animation-delay: 0.6s;">
            <div class="px-2 py-6 border-b border-slate-200 mb-6 flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                <h2 class="font-heading text-xl sm:text-2xl font-bold text-slate-900">
                    <span x-show="lang === 'en'">Tools & Resources</span><span x-show="lang === 'ua'" x-cloak>Інструменти та Матеріали</span>
                </h2>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8 w-full">
                <div class="lg:col-span-1 space-y-6 sm:space-y-8 w-full flex flex-col">
                    
                    <div class="bg-slate-900 p-5 sm:p-6 rounded-2xl shadow-lg border border-slate-800 relative overflow-hidden transition-all duration-300">
                        <div class="flex justify-between items-center mb-6 border-b border-slate-800 pb-3">
                            <span class="text-xs sm:text-sm font-bold text-slate-400 uppercase tracking-wider"><span x-show="lang === 'en'">Live Tuner</span><span x-show="lang === 'ua'" x-cloak>Тюнер</span></span>
                            <button @click="toggleTuner()" class="text-[10px] font-bold uppercase tracking-widest px-3 py-1 rounded-full border transition-colors focus:outline-none" :class="tunerActive ? 'bg-red-500/20 text-red-400 border-red-500/50' : 'bg-transparent text-brass border-brass hover:bg-brass hover:text-white'" x-text="tunerActive ? (lang === 'en' ? 'Stop' : 'Вимк') : (lang === 'en' ? 'Mic Access' : 'Мікрофон')"></button>
                        </div>
                        
                        <div class="flex flex-col items-center justify-center min-h-[140px]">
                            <div x-show="!tunerActive" class="text-center text-slate-500 text-sm font-medium">
                                <span x-show="lang === 'en'">Click "Mic Access" to enable tuner.</span><span x-show="lang === 'ua'" x-cloak>Натисніть "Мікрофон" для активації.</span>
                            </div>
                            <div x-show="tunerActive" class="flex flex-col items-center w-full" x-cloak>
                                <div class="text-5xl font-black text-white mb-2" x-text="tunerNote">--</div>
                                <div class="text-xs font-mono font-bold" :class="Math.abs(tunerCents) < 10 ? 'text-emerald-400' : (tunerCents > 0 ? 'text-rose-400' : 'text-amber-400')" x-text="tunerCents === 0 ? 'In Tune' : (tunerCents > 0 ? '+' + tunerCents + ' Sharp' : tunerCents + ' Flat')"></div>
                                <div class="w-full max-w-[200px] h-2 bg-slate-800 rounded-full mt-6 relative shadow-inner">
                                    <div class="absolute top-1/2 left-1/2 w-0.5 h-4 bg-slate-600 -translate-x-1/2 -translate-y-1/2"></div>
                                    <div class="absolute top-1/2 w-3 h-3 rounded-full shadow-[0_0_10px_rgba(255,255,255,0.5)] -translate-x-1/2 -translate-y-1/2 transition-all duration-75"
                                         :class="Math.abs(tunerCents) < 10 ? 'bg-emerald-400' : 'bg-brass'"
                                         :style="`left: ${Math.max(0, Math.min(100, 50 + (tunerCents / 2)))}%`"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-5 sm:p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col transition-all duration-300 hover:shadow-md flex-grow">
                        <div class="flex flex-wrap justify-between items-center mb-6 border-b border-slate-100 pb-3 gap-3">
                            <span class="text-xs sm:text-sm font-bold text-slate-900 uppercase tracking-wider"><span x-show="lang === 'en'">Pitch Pipe</span><span x-show="lang === 'ua'" x-cloak>Генератор Тону</span></span>
                            <div class="flex items-center gap-2 sm:gap-3 bg-slate-50 px-2 py-1 sm:px-3 sm:py-1 rounded-lg border border-slate-200 shadow-inner">
                                <button @click="octave = Math.max(2, octave - 1); stopNote();" class="text-slate-400 hover:text-brass font-bold px-2 transition-colors">-</button>
                                <span class="text-[10px] sm:text-xs font-bold text-slate-700 font-mono"><span x-show="lang === 'en'">Octave</span><span x-show="lang === 'ua'" x-cloak>Октава</span> <span x-text="octave"></span></span>
                                <button @click="octave = Math.min(6, octave + 1); stopNote();" class="text-slate-400 hover:text-brass font-bold px-2 transition-colors">+</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 sm:grid-cols-6 gap-1.5 sm:gap-2 mb-4">
                            <template x-for="note in notes" :key="note.name">
                                <button @click="playNote(note.freq, note.name)" 
                                    class="py-2.5 sm:py-3 rounded-lg border font-bold text-xs sm:text-sm transition-all duration-150 shadow-sm"
                                    :class="activeNote === (note.name.split('/')[0].replace('↑', '') + octave) ? 'bg-brass text-white border-brass scale-95 shadow-inner' : 'bg-slate-50 text-slate-700 border-slate-200 hover:border-brass hover:text-brass'">
                                    <span x-text="note.name"></span>
                                </button>
                            </template>
                        </div>
                        <button @click="stopNote()" x-show="activeNote" class="mt-auto w-full py-2 bg-slate-100 text-slate-600 rounded-lg text-[10px] sm:text-xs font-bold uppercase tracking-widest hover:bg-slate-200 transition-colors shadow-sm">
                            <span x-show="lang === 'en'">Stop Tone</span><span x-show="lang === 'ua'" x-cloak>Зупинити Тон</span>
                        </button>
                    </div>

                    <div class="bg-white p-5 sm:p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col transition-all duration-300 hover:shadow-md">
                        <div class="mb-4 border-b border-slate-100 pb-3">
                            <h3 class="font-heading text-xs sm:text-sm font-bold text-slate-900 uppercase tracking-wider"><span x-show="lang === 'en'">Blank Sheet Music</span><span x-show="lang === 'ua'" x-cloak>Чисті Ноти</span></h3>
                        </div>
                        <div class="space-y-3 flex-grow">
                            <button @click="printStaves(10)" class="w-full flex items-center justify-between p-3 rounded-xl bg-slate-50 border border-slate-200 hover:border-brass transition-all duration-200 group">
                                <span class="font-bold text-xs sm:text-sm text-slate-700 group-hover:text-brass transition-colors">10 Staves</span>
                                <svg class="w-4 h-4 text-slate-400 group-hover:text-brass transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                            </button>
                            <button @click="printStaves(12)" class="w-full flex items-center justify-between p-3 rounded-xl bg-slate-50 border border-slate-200 hover:border-brass transition-all duration-200 group">
                                <span class="font-bold text-xs sm:text-sm text-slate-700 group-hover:text-brass transition-colors">12 Staves</span>
                                <svg class="w-4 h-4 text-slate-400 group-hover:text-brass transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                            </button>
                        </div>
                    </div>

                </div>

                <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col transition-all duration-300 hover:shadow-md overflow-hidden w-full">
                    <div class="p-5 sm:p-6 border-b border-slate-100 bg-slate-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div class="text-center sm:text-left">
                            <h3 class="font-heading text-base sm:text-lg font-bold text-slate-900">
                                <span x-show="lang === 'en'">Interactive Fingering Chart</span><span x-show="lang === 'ua'" x-cloak>Інтерактивна Аплікатура</span>
                            </h3>
                            <p class="text-[10px] sm:text-xs text-slate-500 font-bold uppercase tracking-widest mt-1">
                                <span x-show="lang === 'en'">Full Chromatic Scale Access.</span><span x-show="lang === 'ua'" x-cloak>Повний хроматичний доступ.</span>
                            </p>
                        </div>
                        <div class="text-xs sm:text-sm font-black text-brass uppercase tracking-widest bg-white border border-slate-200 px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg shadow-sm" x-text="globalInstrument"></div>
                    </div>
                    
                    <div class="p-4 sm:p-8 flex flex-col items-center flex-grow bg-white w-full">
                        
                        <div class="flex justify-center gap-1.5 sm:gap-2 mb-6 sm:mb-8 bg-slate-100 p-1.5 rounded-full shadow-inner max-w-full overflow-x-auto w-full">
                            <template x-for="r in interactiveChart.ranges">
                                <button @click="interactiveChart.selectedRange = r; interactiveChart.selectedNote = 0"
                                        class="px-4 py-1.5 sm:px-5 sm:py-2 text-[10px] sm:text-xs font-bold uppercase rounded-full transition-all duration-200 flex-1 sm:flex-none text-center"
                                        :class="interactiveChart.selectedRange === r ? 'bg-slate-800 text-white shadow-md' : 'text-slate-500 hover:bg-slate-200 hover:text-slate-900'"
                                        x-text="lang === 'en' ? r : (r === 'Low' ? 'Низька' : (r === 'Mid' ? 'Середня' : 'Висока'))"></button>
                            </template>
                        </div>
                        
                        <div class="flex flex-wrap gap-1.5 sm:gap-2.5 justify-center mb-8 sm:mb-10 w-full max-w-2xl min-h-[40px]">
                            <template x-for="(note, index) in interactiveChart.data[interactiveChart.instrument].notes[interactiveChart.selectedRange]">
                                <button @click="interactiveChart.selectedNote = index"
                                    :class="interactiveChart.selectedNote === index ? 'bg-brass text-white shadow-md scale-105' : 'bg-slate-50 text-slate-600 hover:bg-slate-200 hover:text-slate-900 border-slate-200'"
                                    class="px-2.5 py-1.5 sm:px-3 sm:py-2 rounded-lg font-bold text-xs sm:text-sm transition-all duration-200 border"
                                    x-text="note.name">
                                </button>
                            </template>
                        </div>

                        <div class="w-full max-w-lg bg-slate-50 border border-slate-200 shadow-inner rounded-2xl p-6 sm:p-10 flex justify-center items-center min-h-[160px] sm:min-h-[220px] overflow-hidden">
                            
                            <template x-if="interactiveChart.data[interactiveChart.instrument].type === 'valves'">
                                <div class="flex gap-4 sm:gap-8">
                                    <template x-for="(v, i) in interactiveChart.data[interactiveChart.instrument].notes[interactiveChart.selectedRange][interactiveChart.selectedNote].val">
                                        <div class="flex flex-col items-center gap-3 sm:gap-4">
                                            <div class="w-12 h-12 sm:w-16 sm:h-16 rounded-full border-[4px] sm:border-[5px] shadow-md transition-all duration-300"
                                                 :class="v ? 'bg-brass border-brass scale-95 shadow-inner' : 'bg-white border-slate-300'"></div>
                                            <span class="font-black text-slate-400 text-xs sm:text-sm" x-text="i+1"></span>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            
                            <template x-if="interactiveChart.data[interactiveChart.instrument].type === 'slide'">
                                <div class="flex flex-col items-center w-full max-w-md">
                                    <span class="text-5xl sm:text-6xl font-black text-brass mb-2 transition-all duration-300" x-text="interactiveChart.data[interactiveChart.instrument].notes[interactiveChart.selectedRange][interactiveChart.selectedNote].pos"></span>
                                    <span class="text-xs sm:text-sm font-bold text-slate-400 uppercase tracking-widest mb-6 sm:mb-8">
                                        <span x-show="lang === 'en'">Position</span><span x-show="lang === 'ua'" x-cloak>Позиція</span>
                                    </span>
                                    <div class="w-full h-4 sm:h-5 bg-slate-200 rounded-full relative flex items-center mt-2 mb-3 shadow-inner">
                                        <div class="absolute h-8 w-8 sm:h-10 sm:w-10 bg-brass rounded-full shadow-lg transition-all duration-500 ease-in-out border-[3px] sm:border-4 border-white"
                                             class="-ml-4 sm:-ml-5"
                                             :style="`left: ${ (interactiveChart.data[interactiveChart.instrument].notes[interactiveChart.selectedRange][interactiveChart.selectedNote].pos - 1) * (100 / 6) }%`"></div>
                                    </div>
                                    <div class="w-full flex justify-between mt-2 text-[10px] sm:text-xs font-bold text-slate-400 px-1">
                                        <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span>
                                    </div>
                                </div>
                            </template>
                            
                            <template x-if="interactiveChart.data[interactiveChart.instrument].type === 'woodwind'">
                                <div class="flex flex-col sm:flex-row items-center gap-6 sm:gap-10">
                                    <div class="flex items-center gap-2 sm:gap-4 bg-white px-3 py-3 sm:px-5 sm:py-4 rounded-2xl border border-slate-200 shadow-sm">
                                        <span class="text-xs sm:text-sm font-bold text-slate-400 w-6 sm:w-8 text-right">LH</span>
                                        <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full border-[3px] sm:border-[4px] shadow-sm transition-all duration-300 flex-shrink-0" :class="interactiveChart.data[interactiveChart.instrument].notes[interactiveChart.selectedRange][interactiveChart.selectedNote].lh[0] ? 'bg-brass border-brass scale-95 shadow-inner' : 'bg-slate-50 border-slate-300'"></div>
                                        <div class="w-px h-10 sm:h-12 bg-slate-200 mx-1 sm:mx-2"></div>
                                        <div class="flex gap-1.5 sm:gap-3">
                                            <template x-for="i in [1, 2, 3]">
                                                <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full border-[3px] sm:border-[4px] shadow-sm transition-all duration-300 flex-shrink-0" :class="interactiveChart.data[interactiveChart.instrument].notes[interactiveChart.selectedRange][interactiveChart.selectedNote].lh[i] ? 'bg-brass border-brass scale-95 shadow-inner' : 'bg-slate-50 border-slate-300'"></div>
                                            </template>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2 sm:gap-4 bg-white px-3 py-3 sm:px-5 sm:py-4 rounded-2xl border border-slate-200 shadow-sm">
                                        <span class="text-xs sm:text-sm font-bold text-slate-400 w-6 sm:w-8 text-right">RH</span>
                                        <div class="flex gap-1.5 sm:gap-3">
                                            <template x-for="i in [0, 1, 2]">
                                                <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full border-[3px] sm:border-[4px] shadow-sm transition-all duration-300 flex-shrink-0" :class="interactiveChart.data[interactiveChart.instrument].notes[interactiveChart.selectedRange][interactiveChart.selectedNote].rh[i] ? 'bg-brass border-brass scale-95 shadow-inner' : 'bg-slate-50 border-slate-300'"></div>
                                            </template>
                                        </div>
                                        <div class="w-px h-10 sm:h-12 bg-slate-200 mx-1 sm:mx-2"></div>
                                        <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full border-[3px] sm:border-[4px] shadow-sm transition-all duration-300 flex-shrink-0" :class="interactiveChart.data[interactiveChart.instrument].notes[interactiveChart.selectedRange][interactiveChart.selectedNote].rh[3] ? 'bg-brass border-brass scale-95 shadow-inner' : 'bg-slate-50 border-slate-300'"></div>
                                    </div>
                                </div>
                            </template>
                            
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-white border-t border-slate-200 py-12 text-center mt-auto">
        <div class="max-w-7xl mx-auto px-4 space-y-4">
            <div class="font-bold text-slate-900 tracking-tight text-lg">FUBC <span class="text-brass">MUSIC SCHOOL</span></div>
            <p class="text-xs text-slate-400">&copy; 2026 First Ukrainian Baptist Church Band.</p>
            <p class="text-[10px] sm:text-xs text-slate-400 mt-2 uppercase tracking-widest font-bold">Created and designed by Roman Kucheryavyy</p>
        </div>
    </footer>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('schoolApp', () => ({
                lang: 'en',
                mobileMenuOpen: false,
                fullScreenModalOpen: false,
                currentFullScreenIdx: 0,
                scrollY: 0,
                scrollProgress: 0,
                
                // --- GLOBAL INSTRUMENT STATE ---
                availableInstruments: ['Flute', 'Oboe', 'Clarinet', 'Saxophone', 'Trumpet', 'French Horn', 'Tenor Horn', 'Baritone', 'Trombone', 'Tuba'],
                globalInstrument: localStorage.getItem('fubc_school_instrument') || 'Trumpet',
                selectedGroup: 0,

                // Practice Tracker & Timer Logic
                streak: parseInt(localStorage.getItem('fubc_school_streak')) || 0,
                lastPractice: localStorage.getItem('fubc_school_last_date') || '',
                practicedToday: false,
                
                sessionActive: false,
                sessionTimer: null,
                sessionPhase: 0,
                sessionTimeLeft: 300, // 5 mins in seconds
                sessionPhases: [
                    { name: 'Warm-Ups', duration: 300 }, // 5 mins
                    { name: 'Repertoire', duration: 900 }, // 15 mins
                    { name: 'Review / Fun', duration: 300 }  // 5 mins
                ],

                // Form submission state
                submitStatus: 'idle',

                // Audio Playback State for ABCJS
                playingExerciseIdx: null,
                exerciseAudioTimer: null,

                schoolSongs: [
                    { title: "Юношу Иосифа", desc_en: "Rhythmic precision focus.", desc_ua: "Точність ритму.", link: "https://ifob.su/band/instrumental/simple/yunoshu-iosifa/" },
                    { title: "Пока огонь", desc_en: "Focus on breath support.", desc_ua: "Увага на дихання.", link: "https://ifob.su/band/instrumental/simple/poka-ogoni-af/" },
                    { title: "Только", desc_en: "Work on finger speed.", desc_ua: "Робота над технікою пальців.", link: "https://ifob.su/band/instrumental/simple/tolko-ra/" },
                    { title: "Господь благослови", desc_en: "Maintain steady tempo.", desc_ua: "Тримайте рівний темп.", link: "https://ifob.su/band/instrumental/simple/g-blagoslovi-af/" },
                    { title: "Я маленький скиталец", desc_en: "Articulation and staccato.", desc_ua: "Артикуляція та стакато.", link: "https://ifob.su/band/for-children/ja-malenkiy-skitalets-orc-so/" },
                    { title: "Славьте Бога", desc_en: "Dynamics and full tone.", desc_ua: "Динаміка і повний звук.", link: "https://ifob.su/band/instrumental/simple/slavte-boga-ra/" },
                    { title: "Как овечку", desc_en: "Lyrical, flowing phrasing.", desc_ua: "Кантиленне фразування.", link: "https://ifob.su/band/instrumental/simple/kak-ovechku-ra/" },
                    { title: "Се у дверей", desc_en: "Watch for tempo shifts.", desc_ua: "Увага на зміни темпу.", link: "https://ifob.su/band/instrumental/simple/se-u-dverei-ra/" }
                ],

                instrumentGroups: [
                    { name_en: 'C Treble', clef: 'treble', key: 'Bb' },
                    { name_en: 'Bb Instruments', clef: 'treble', key: 'C' },
                    { name_en: 'Eb Instruments', clef: 'treble', key: 'G' },
                    { name_en: 'F Instruments', clef: 'treble', key: 'F' },
                    { name_en: 'C Bass', clef: 'bass', key: 'Bb' }
                ],

                exercises: [
                    { title_en: '1. Long Tones', title_ua: '1. Довгі Ноти', abc: ['L:1/4\nB4 | A4 | G4 | F4 | E4 | D4 | C4 | B,4 |]', 'L:1/4\nc4 | B4 | A4 | G4 | F4 | E4 | D4 | C4 |]', 'L:1/4\nG4 | F4 | E4 | D4 | C4 | B,4 | A,4 | G,4 |]', 'L:1/4\nF4 | E4 | D4 | C4 | B,4 | A,4 | G,4 | F,4 |]', 'L:1/4\nB,4 | A,4 | G,4 | F,4 | E,4 | D,4 | C,4 | B,,4 |]'] },
                    { title_en: '2. Flexibility / Lip Slurs', title_ua: '2. Гнучкість / Легато', abc: ['L:1/8\n(B, F B, F B,2) z2 | (C G C G C2) z2 | (D A D A D2) z2 | (E B E B E2) z2 |]', 'L:1/8\n(C G C G C2) z2 | (D A D A D2) z2 | (E B E B E2) z2 | (F c F c F2) z2 |]', 'L:1/8\n(G, D G, D G,2) z2 | (A, E A, E A,2) z2 | (B, F B, F B,2) z2 | (C G C G C2) z2 |]', 'L:1/8\n(F, C F, C F,2) z2 | (G, D G, D G,2) z2 | (A, E A, E A,2) z2 | (B, F B, F B,2) z2 |]', 'L:1/8\n(B,, F, B,, F, B,,2) z2 | (C, G, C, G, C,2) z2 | (D, A, D, A, D,2) z2 | (E, B, E, B, E,2) z2 |]'] },
                    { title_en: '3. Articulation', title_ua: '3. Артикуляція', abc: ['L:1/8\n.F.F .F.F .F.F .F.F | F2 z2 F2 z2 | .B,.B, .B,.B, .B,.B, .B,.B, | B,2 z2 B,2 z2 |]', 'L:1/8\n.G.G .G.G .G.G .G.G | G2 z2 G2 z2 | .C.C .C.C .C.C .C.C | C2 z2 C2 z2 |]', 'L:1/8\n.D.D .D.D .D.D .D.D | D2 z2 D2 z2 | .G,.G, .G,.G, .G,.G, .G,.G, | G,2 z2 G,2 z2 |]', 'L:1/8\n.C.C .C.C .C.C .C.C | C2 z2 C2 z2 | .F,.F, .F,.F, .F,.F, .F,.F, | F,2 z2 F,2 z2 |]', 'L:1/8\n.F,.F, .F,.F, .F,.F, .F,.F, | F,2 z2 F,2 z2 | .B,,.B,, .B,,.B,, .B,,.B,, .B,,.B,, | B,,2 z2 B,,2 z2 |]'] },
                    { title_en: '4. Scale & Arpeggio', title_ua: '4. Гамма і Арпеджіо', abc: ['L:1/8\nB, C D E F G A B | B A G F E D C B, | B, D F B B F D B, | B,8 |]', 'L:1/8\nC D E F G A B c | c B A G F E D C | C E G c c G E C | C8 |]', 'L:1/8\nG, A, B, C D E F G | G F E D C B, A, G, | G, B, D G G D B, G, | G,8 |]', 'L:1/8\nF, G, A, B, C D E F | F E D C B, A, G, F, | F, A, C F F C A, F, | F,8 |]', 'L:1/8\nB,, C, D, E, F, G, A, B, | B, A, G, F, E, D, C, B,, | B,, D, F, B, B, F, D, B,, | B,,8 |]'] },
                    { title_en: '5. Intervals', title_ua: '5. Інтервали', abc: ['L:1/8\nB, D C E D F E G | F A G B A c B2 | B G A F G E F D | E C D B, C A, B,2 |]', 'L:1/8\nC E D F E G F A | G B A c B d c2 | c A B G A F G E | F D E C D B, C2 |]', 'L:1/8\nG, B, A, C B, D C E | D F E G F A G2 | G E F D E C D B, | C A, B, G, A, F, G,2 |]', 'L:1/8\nF, A, G, B, A, C B, D | C E D F E G F2 | F D E C D B, C A, | B, G, A, F, G, E, F,2 |]', 'L:1/8\nB,, D, C, E, D, F, E, G, | F, A, G, B, A, c B,2 | B, G, A, F, G, E, F, D, | E, C, D, B,, C, A,, B,,2 |]'] },
                    { title_en: '6. Chromatic Study', title_ua: '6. Хроматика', abc: ['L:1/8\nB, =B, C ^C D2 z2 | D _D C =B, B,2 z2 | F ^F G ^G A2 z2 | A _A G _G F2 z2 |]', 'L:1/8\nC ^C D ^D E2 z2 | E _E D _D C2 z2 | G ^G A ^A B2 z2 | B _B A _A G2 z2 |]', 'L:1/8\nG, ^G, A, ^A, B,2 z2 | B, _B, A, _A, G,2 z2 | D ^D E =F F2 z2 | F =F E _E D2 z2 |]', 'L:1/8\nF, ^F, G, ^G, A,2 z2 | A, _A, G, _G, F,2 z2 | C ^C D ^D E2 z2 | E _E D _D C2 z2 |]', 'L:1/8\nB,, =B,, C, ^C, D,2 z2 | D, _D, C, =B,, B,,2 z2 | F, ^F, G, ^G, A,2 z2 | A, _A, G, _G, F,2 z2 |]'] }
                ],

                async init() {
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    if (this.lastPractice) {
                        const last = new Date(this.lastPractice);
                        last.setHours(0,0,0,0);
                        const diffTime = today.getTime() - last.getTime();
                        const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays === 0) { this.practicedToday = true; } 
                        else if (diffDays > 1) { this.streak = 0; localStorage.setItem('fubc_school_streak', 0); }
                    }
                    
                    // Fetch dynamic setlist
                    try {
                        const response = await fetch('/data.json?t=' + new Date().getTime());
                        if (response.ok) {
                            const json = await response.json();
                            if(json.schoolSetlist) { this.schoolSongs = json.schoolSetlist; }
                        }
                    } catch(e) { console.log('Using default school setlist'); }

                    this.updateGlobalInstrument(this.globalInstrument);
                },

                formatTime(seconds) {
                    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const s = (seconds % 60).toString().padStart(2, '0');
                    return `${m}:${s}`;
                },

                toggleSession() {
                    if (this.sessionActive) {
                        clearInterval(this.sessionTimer);
                        this.sessionActive = false;
                    } else {
                        this.sessionActive = true;
                        this.sessionTimer = setInterval(() => {
                            if (this.sessionTimeLeft > 0) {
                                this.sessionTimeLeft--;
                            } else {
                                if (this.sessionPhase < 2) {
                                    this.sessionPhase++;
                                    this.sessionTimeLeft = this.sessionPhases[this.sessionPhase].duration;
                                } else {
                                    clearInterval(this.sessionTimer);
                                    this.sessionActive = false;
                                    this.logPractice(); // Automatically log on completion!
                                }
                            }
                        }, 1000);
                    }
                },

                resetSession() {
                    clearInterval(this.sessionTimer);
                    this.sessionActive = false;
                    this.sessionPhase = 0;
                    this.sessionTimeLeft = this.sessionPhases[0].duration;
                },

                updateGlobalInstrument(inst) {
                    this.globalInstrument = inst;
                    localStorage.setItem('fubc_school_instrument', inst);
                    
                    this.interactiveChart.instrument = inst;
                    this.interactiveChart.selectedNote = 0;
                    if(this.activeNote) this.stopNote();
                    
                    let groupIdx = 0;
                    if (['Flute', 'Oboe'].includes(inst)) groupIdx = 0;
                    else if (['Clarinet', 'Trumpet'].includes(inst)) groupIdx = 1;
                    else if (['Saxophone', 'Tenor Horn'].includes(inst)) groupIdx = 2;
                    else if (['French Horn'].includes(inst)) groupIdx = 3;
                    else if (['Trombone', 'Baritone', 'Tuba'].includes(inst)) groupIdx = 4;
                    
                    this.selectedGroup = groupIdx;
                    this.$nextTick(() => { this.renderWarmups(); });
                },

                renderWarmups() {
                    if (typeof ABCJS !== 'undefined') {
                        const group = this.instrumentGroups[this.selectedGroup];
                        const scale = window.innerWidth < 640 ? 0.8 : 1.0;
                        const options = { responsive: 'resize', scale: scale, paddingbottom: 5, paddingtop: 15, paddingleft: 0, paddingright: 0 };
                        this.exercises.forEach((ex, idx) => {
                            const header = `X:${idx+1}\nM:4/4\nQ:1/4=100\nK:${group.key} clef=${group.clef}\n`;
                            ABCJS.renderAbc(`abc-warmup-${idx}`, header + ex.abc[this.selectedGroup], options);
                        });
                    }
                },

                openFullScreen(idx) {
                    this.currentFullScreenIdx = idx;
                    this.fullScreenModalOpen = true;
                    this.$nextTick(() => {
                        const group = this.instrumentGroups[this.selectedGroup];
                        const ex = this.exercises[idx];
                        const header = `X:${idx+1}\nM:4/4\nK:${group.key} clef=${group.clef}\n`;
                        const modalScale = window.innerWidth < 640 ? 1.0 : 1.8;
                        ABCJS.renderAbc('abc-fullscreen', header + ex.abc[this.selectedGroup], { 
                            responsive: 'resize', scale: modalScale, paddingtop: 30, paddingbottom: 30
                        });
                    });
                },

                // Audio Sequencer for Warmups
                playExerciseAudio(idx) {
                    if (this.playingExerciseIdx === idx) {
                        this.stopNote();
                        this.playingExerciseIdx = null;
                        clearTimeout(this.exerciseAudioTimer);
                        return;
                    }
                    
                    this.stopNote();
                    clearTimeout(this.exerciseAudioTimer);
                    this.playingExerciseIdx = idx;
                    
                    const abcString = this.exercises[idx].abc[this.selectedGroup];
                    
                    // Super basic pseudo-sequencer for the hardcoded warmups
                    // Parses the L:1/8 or L:1/4 header and extracts simple notes for playback.
                    let baseLengthMs = abcString.includes('L:1/8') ? 300 : 600; // ~100bpm
                    
                    // Strip header, bar lines, slurs, spaces
                    let notesStr = abcString.split('\n')[1].replace(/[|() \.]/g, '').replace(/z2/g, 'zz').replace(/z4/g, 'zzzz');
                    let sequence = [];
                    
                    let i = 0;
                    while(i < notesStr.length) {
                        if(notesStr[i] === ']') break;
                        let acc = '';
                        if(notesStr[i] === '^' || notesStr[i] === '_' || notesStr[i] === '=') { acc = notesStr[i]; i++; }
                        let noteLetter = notesStr[i]; i++;
                        let oct = '';
                        while (notesStr[i] === ',' || notesStr[i] === "'") { oct += notesStr[i]; i++; }
                        let durationMultiplier = 1;
                        if (/[0-9]/.test(notesStr[i])) { durationMultiplier = parseInt(notesStr[i]); i++; }
                        
                        sequence.push({ letter: noteLetter, acc: acc, oct: oct, dur: durationMultiplier * baseLengthMs });
                    }

                    // A map to help find the correct frequency based on ABC notation letter + octave marks
                    const getFreq = (l, a, o) => {
                        if(l === 'z') return 0;
                        let baseMap = { 'C':16.35, 'D':18.35, 'E':20.60, 'F':21.83, 'G':24.50, 'A':27.50, 'B':30.87, 'c':32.70, 'd':36.71, 'e':41.20, 'f':43.65, 'g':49.00, 'a':55.00, 'b':61.74 };
                        let f = baseMap[l];
                        if(!f) return 0;
                        if(a==='^') f *= 1.05946; if(a==='_') f /= 1.05946;
                        let octShift = 0;
                        for(let c of o) { if(c===',') octShift--; if(c==="'") octShift++; }
                        return f * Math.pow(2, octShift + 3); // Shift up to audible range
                    };

                    let seqIdx = 0;
                    const playNext = () => {
                        if(seqIdx >= sequence.length || this.playingExerciseIdx !== idx) {
                            this.stopNote();
                            this.playingExerciseIdx = null;
                            return;
                        }
                        let n = sequence[seqIdx];
                        let freq = getFreq(n.letter, n.acc, n.oct);
                        
                        if(freq > 0) {
                            // Play note for 90% of duration to give articulation gap
                            this.playToneEngine(freq);
                            setTimeout(() => this.stopNote(), n.dur * 0.9);
                        }
                        
                        this.exerciseAudioTimer = setTimeout(playNext, n.dur);
                        seqIdx++;
                    };
                    playNext();
                },

                // LIVE MICROPHONE TUNER
                tunerActive: false,
                tunerNote: '--',
                tunerCents: 0,
                audioContext: null,
                analyser: null,
                micStream: null,
                animationId: null,

                toggleTuner() {
                    if (this.tunerActive) {
                        this.stopTuner();
                    } else {
                        this.startTuner();
                    }
                },

                async startTuner() {
                    try {
                        this.micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        this.analyser = this.audioContext.createAnalyser();
                        this.analyser.fftSize = 2048;
                        const source = this.audioContext.createMediaStreamSource(this.micStream);
                        source.connect(this.analyser);
                        this.tunerActive = true;
                        this.updatePitch();
                    } catch (err) {
                        alert("Microphone access denied or not available.");
                    }
                },

                stopTuner() {
                    if (this.micStream) this.micStream.getTracks().forEach(t => t.stop());
                    if (this.audioContext) this.audioContext.close();
                    if (this.animationId) cancelAnimationFrame(this.animationId);
                    this.tunerActive = false;
                    this.tunerNote = '--';
                    this.tunerCents = 0;
                },

                updatePitch() {
                    if (!this.tunerActive) return;
                    const buffer = new Float32Array(this.analyser.fftSize);
                    this.analyser.getFloatTimeDomainData(buffer);
                    const acFreq = this.autoCorrelate(buffer, this.audioContext.sampleRate);
                    
                    if (acFreq !== -1) {
                        // Math to convert frequency to closest musical note
                        const noteNum = 12 * (Math.log(acFreq / 440) / Math.log(2));
                        const noteIndex = Math.round(noteNum) + 69;
                        const notes = ['C', 'C#', 'D', 'Eb', 'E', 'F', 'F#', 'G', 'G#', 'A', 'Bb', 'B'];
                        this.tunerNote = notes[noteIndex % 12];
                        
                        // Calculate cents off
                        const expectedFreq = 440 * Math.pow(2, (noteIndex - 69) / 12);
                        this.tunerCents = Math.floor(1200 * Math.log2(acFreq / expectedFreq));
                    }
                    this.animationId = requestAnimationFrame(() => this.updatePitch());
                },

                autoCorrelate(buf, sampleRate) {
                    let SIZE = buf.length;
                    let rms = 0;
                    for (let i=0;i<SIZE;i++) rms += buf[i]*buf[i];
                    rms = Math.sqrt(rms/SIZE);
                    if (rms<0.01) return -1; // Not enough signal

                    let r1=0, r2=SIZE-1, thres=0.2;
                    for(let i=0; i<SIZE/2; i++) if (Math.abs(buf[i])<thres) { r1=i; break; }
                    for(let i=1; i<SIZE/2; i++) if (Math.abs(buf[SIZE-i])<thres) { r2=SIZE-i; break; }

                    buf = buf.slice(r1,r2);
                    SIZE = buf.length;

                    let c = new Array(SIZE).fill(0);
                    for (let i=0; i<SIZE; i++) {
                        for (let j=0; j<SIZE-i; j++) {
                            c[i] = c[i] + buf[j]*buf[j+i];
                        }
                    }

                    let d=0; while (c[d]>c[d+1]) d++;
                    let maxval=-1, maxpos=-1;
                    for (let i=d; i<SIZE; i++) {
                        if (c[i] > maxval) { maxval = c[i]; maxpos = i; }
                    }
                    let T0 = maxpos;
                    let x1=c[T0-1], x2=c[T0], x3=c[T0+1];
                    let a = (x1 + x3 - 2*x2)/2;
                    let b = (x3 - x1)/2;
                    if (a) T0 = T0 - b/(2*a);
                    return sampleRate/T0;
                },

                submitTest(e) {
                    this.submitStatus = 'submitting';
                    const formData = new FormData(this.$refs.testForm);
                    fetch('/', { method: 'POST', body: formData })
                    .then(() => {
                        this.submitStatus = 'success';
                        confetti({ particleCount: 150, spread: 70, origin: { y: 0.7 }, colors: ['#b45309', '#d97706', '#ffffff'], zIndex: 1000 });
                        this.$refs.testForm.reset();
                        setTimeout(() => this.submitStatus = 'idle', 5000);
                    })
                    .catch(() => { alert('Upload failed. Check your connection or file size.'); this.submitStatus = 'idle'; });
                },

                // Interactive Fingering Chart Data
                interactiveChart: {
                    instrument: 'Trumpet',
                    selectedRange: 'Mid',
                    selectedNote: 0,
                    ranges: ['Low', 'Mid', 'High'],
                    data: {
                        'Flute': { type: 'woodwind', notes: { 
                            'Low': [ { name: 'C', lh: [0,1,1,1], rh: [1,1,1,1] }, { name: 'D', lh: [1,1,1,1], rh: [1,1,1,0] }, { name: 'E', lh: [1,1,1,1], rh: [1,1,0,1] }, { name: 'F', lh: [1,1,1,1], rh: [1,0,0,1] }, { name: 'G', lh: [1,1,1,1], rh: [0,0,0,1] }, { name: 'A', lh: [1,1,1,0], rh: [0,0,0,1] }, { name: 'B', lh: [1,1,0,0], rh: [0,0,0,1] } ], 
                            'Mid': [ { name: 'C', lh: [0,1,0,0], rh: [0,0,0,1] }, { name: 'Db', lh: [0,0,0,0], rh: [0,0,0,1] }, { name: 'D', lh: [1,0,1,1], rh: [1,1,1,0] }, { name: 'Eb', lh: [1,0,1,1], rh: [1,1,1,1] }, { name: 'E', lh: [1,1,1,1], rh: [1,1,0,1] }, { name: 'F', lh: [1,1,1,1], rh: [1,0,0,1] }, { name: 'Gb', lh: [1,1,1,1], rh: [0,0,1,1] }, { name: 'G', lh: [1,1,1,1], rh: [0,0,0,1] }, { name: 'Ab', lh: [1,1,1,1], rh: [0,0,0,1] }, { name: 'A', lh: [1,1,1,0], rh: [0,0,0,1] }, { name: 'Bb', lh: [1,1,0,0], rh: [1,0,0,1] }, { name: 'B', lh: [1,1,0,0], rh: [0,0,0,1] }, { name: 'C↑', lh: [0,1,0,0], rh: [0,0,0,1] } ], 
                            'High': [ { name: 'C', lh: [0,1,0,0], rh: [0,0,0,1] }, { name: 'D', lh: [1,0,1,1], rh: [0,0,0,0] }, { name: 'E', lh: [1,1,1,0], rh: [1,1,0,1] }, { name: 'F', lh: [1,1,0,1], rh: [1,0,0,1] }, { name: 'G', lh: [1,0,1,1], rh: [0,0,0,1] }, { name: 'A', lh: [1,0,1,0], rh: [1,0,0,1] }, { name: 'B', lh: [1,0,0,0], rh: [0,0,0,1] } ] 
                        } },
                        'Oboe': { type: 'woodwind', notes: { 
                            'Low': [ { name: 'C', lh: [0,1,1,1], rh: [1,1,1,1] }, { name: 'D', lh: [0,1,1,1], rh: [1,1,1,0] }, { name: 'E', lh: [0,1,1,1], rh: [1,1,0,0] }, { name: 'F', lh: [0,1,1,1], rh: [1,0,0,0] }, { name: 'G', lh: [0,1,1,1], rh: [0,0,0,0] }, { name: 'A', lh: [0,1,1,0], rh: [0,0,0,0] }, { name: 'B', lh: [0,1,0,0], rh: [0,0,0,0] } ], 
                            'Mid': [ { name: 'C', lh: [0,0,1,0], rh: [0,0,0,0] }, { name: 'Db', lh: [0,0,0,0], rh: [0,0,0,0] }, { name: 'D', lh: [1,1,1,1], rh: [1,1,1,0] }, { name: 'Eb', lh: [1,1,1,1], rh: [1,1,1,1] }, { name: 'E', lh: [1,1,1,1], rh: [1,1,0,0] }, { name: 'F', lh: [1,1,1,1], rh: [1,0,0,0] }, { name: 'Gb', lh: [1,1,1,1], rh: [0,1,0,0] }, { name: 'G', lh: [1,1,1,1], rh: [0,0,0,0] }, { name: 'Ab', lh: [1,1,1,1], rh: [0,0,0,0] }, { name: 'A', lh: [1,1,1,0], rh: [0,0,0,0] }, { name: 'Bb', lh: [1,1,0,0], rh: [1,0,0,0] }, { name: 'B', lh: [1,1,0,0], rh: [0,0,0,0] }, { name: 'C↑', lh: [1,0,1,0], rh: [0,0,0,0] } ], 
                            'High': [ { name: 'C', lh: [1,0,1,0], rh: [0,0,0,0] }, { name: 'D', lh: [1,0,1,1], rh: [0,0,0,0] }, { name: 'E', lh: [1,0,1,0], rh: [1,0,0,0] }, { name: 'F', lh: [1,0,1,0], rh: [0,1,0,0] }, { name: 'G', lh: [1,0,1,0], rh: [0,0,0,0] }, { name: 'A', lh: [1,0,1,1], rh: [0,0,0,0] }, { name: 'B', lh: [1,0,0,0], rh: [0,0,0,0] } ] 
                        } },
                        'Clarinet': { type: 'woodwind', notes: { 
                            'Low': [ { name: 'E', lh: [1,1,1,1], rh: [1,1,1,1] }, { name: 'F', lh: [1,1,1,1], rh: [1,1,1,0] }, { name: 'G', lh: [1,1,1,1], rh: [1,1,0,0] }, { name: 'A', lh: [1,1,1,1], rh: [1,0,0,0] }, { name: 'B', lh: [1,1,1,1], rh: [0,0,0,0] }, { name: 'C', lh: [1,1,1,0], rh: [0,0,0,0] } ], 
                            'Mid': [ { name: 'C', lh: [1,1,1,0], rh: [0,0,0,0] }, { name: 'Db', lh: [1,1,1,0], rh: [0,0,0,0] }, { name: 'D', lh: [1,1,0,0], rh: [0,0,0,0] }, { name: 'Eb', lh: [1,1,0,0], rh: [0,0,0,0] }, { name: 'E', lh: [1,0,0,0], rh: [0,0,0,0] }, { name: 'F', lh: [0,0,0,0], rh: [0,0,0,0] }, { name: 'Gb', lh: [0,0,0,0], rh: [0,0,0,0] }, { name: 'G', lh: [0,0,0,0], rh: [0,0,0,0] }, { name: 'Ab', lh: [0,0,0,0], rh: [0,0,0,0] }, { name: 'A', lh: [0,0,0,0], rh: [0,0,0,0] }, { name: 'Bb', lh: [0,0,0,0], rh: [0,0,0,0] }, { name: 'B', lh: [1,1,1,1], rh: [1,1,1,1] }, { name: 'C↑', lh: [1,1,1,1], rh: [1,1,1,0] } ], 
                            'High': [ { name: 'C', lh: [1,1,1,1], rh: [1,1,1,0] }, { name: 'D', lh: [1,1,1,1], rh: [1,1,0,0] }, { name: 'E', lh: [1,1,1,1], rh: [1,0,0,0] }, { name: 'F', lh: [1,1,1,1], rh: [0,0,0,0] }, { name: 'G', lh: [1,1,1,0], rh: [0,0,0,0] }, { name: 'A', lh: [1,1,0,0], rh: [0,0,0,0] } ] 
                        } },
                        'Saxophone': { type: 'woodwind', notes: { 
                            'Low': [ { name: 'Bb', lh: [0,1,1,1], rh: [1,1,1,1] }, { name: 'C', lh: [0,1,1,1], rh: [1,1,1,0] }, { name: 'D', lh: [0,1,1,1], rh: [1,1,1,0] }, { name: 'E', lh: [0,1,1,1], rh: [1,1,0,0] }, { name: 'F', lh: [0,1,1,1], rh: [1,0,0,0] } ], 
                            'Mid': [ { name: 'G', lh: [0,1,1,1], rh: [0,0,0,0] }, { name: 'Ab', lh: [0,1,1,1], rh: [0,0,0,0] }, { name: 'A', lh: [0,1,1,0], rh: [0,0,0,0] }, { name: 'Bb', lh: [0,1,1,0], rh: [1,0,0,0] }, { name: 'B', lh: [0,1,0,0], rh: [0,0,0,0] }, { name: 'C', lh: [0,0,1,0], rh: [0,0,0,0] }, { name: 'Db', lh: [0,0,0,0], rh: [0,0,0,0] }, { name: 'D', lh: [1,1,1,1], rh: [1,1,1,0] }, { name: 'Eb', lh: [1,1,1,1], rh: [1,1,1,1] }, { name: 'E', lh: [1,1,1,1], rh: [1,1,0,0] }, { name: 'F', lh: [1,1,1,1], rh: [1,0,0,0] }, { name: 'Gb', lh: [1,1,1,1], rh: [0,1,0,0] }, { name: 'G↑', lh: [1,1,1,1], rh: [0,0,0,0] } ], 
                            'High': [ { name: 'G', lh: [1,1,1,1], rh: [0,0,0,0] }, { name: 'A', lh: [1,1,1,0], rh: [0,0,0,0] }, { name: 'B', lh: [1,1,0,0], rh: [0,0,0,0] }, { name: 'C', lh: [1,0,1,0], rh: [0,0,0,0] }, { name: 'D', lh: [1,0,0,0], rh: [0,0,0,0] }, { name: 'E', lh: [1,1,1,1], rh: [1,1,0,0] }, { name: 'F', lh: [1,1,0,1], rh: [1,0,0,0] } ] 
                        } },
                        'Trumpet': { type: 'valves', notes: { 
                            'Low': [ { name: 'F#', val: [1,1,1] }, { name: 'G', val: [1,0,1] }, { name: 'Ab', val: [0,1,1] }, { name: 'A', val: [1,1,0] }, { name: 'Bb', val: [1,0,0] }, { name: 'B', val: [0,1,0] }, { name: 'C', val: [0,0,0] } ], 
                            'Mid': [ { name: 'C', val: [0,0,0] }, { name: 'C#/Db', val: [1,1,1] }, { name: 'D', val: [1,0,1] }, { name: 'Eb', val: [0,1,1] }, { name: 'E', val: [1,1,0] }, { name: 'F', val: [1,0,0] }, { name: 'F#/Gb', val: [0,1,0] }, { name: 'G', val: [0,0,0] }, { name: 'Ab', val: [0,1,1] }, { name: 'A', val: [1,1,0] }, { name: 'Bb', val: [1,0,0] }, { name: 'B', val: [0,1,0] }, { name: 'C↑', val: [0,0,0] } ], 
                            'High': [ { name: 'C', val: [0,0,0] }, { name: 'D', val: [1,0,0] }, { name: 'E', val: [0,0,0] }, { name: 'F', val: [1,0,0] }, { name: 'G', val: [0,0,0] }, { name: 'A', val: [1,1,0] }, { name: 'B', val: [0,1,0] }, { name: 'C↑', val: [0,0,0] } ] 
                        } },
                        'French Horn': { type: 'valves', notes: { 
                            'Low': [ { name: 'C', val: [0,0,0] }, { name: 'D', val: [1,0,1] }, { name: 'E', val: [0,1,0] }, { name: 'F', val: [0,0,0] }, { name: 'G', val: [0,0,0] }, { name: 'A', val: [1,1,0] }, { name: 'B', val: [0,1,0] } ], 
                            'Mid': [ { name: 'C', val: [0,0,0] }, { name: 'Db', val: [1,1,0] }, { name: 'D', val: [1,0,0] }, { name: 'Eb', val: [0,1,0] }, { name: 'E', val: [0,0,0] }, { name: 'F', val: [1,0,0] }, { name: 'Gb', val: [0,1,0] }, { name: 'G', val: [0,0,0] }, { name: 'Ab', val: [0,1,1] }, { name: 'A', val: [1,1,0] }, { name: 'Bb', val: [1,0,0] }, { name: 'B', val: [0,1,0] }, { name: 'C↑', val: [0,0,0] } ], 
                            'High': [ { name: 'C', val: [0,0,0] }, { name: 'D', val: [1,0,0] }, { name: 'E', val: [0,0,0] }, { name: 'F', val: [1,0,0] }, { name: 'G', val: [0,0,0] }, { name: 'A', val: [1,1,0] }, { name: 'B', val: [0,1,0] }, { name: 'C↑', val: [0,0,0] } ] 
                        } },
                        'Tenor Horn': { type: 'valves', notes: { 
                            'Low': [ { name: 'F#', val: [1,1,1] }, { name: 'G', val: [1,0,1] }, { name: 'Ab', val: [0,1,1] }, { name: 'A', val: [1,1,0] }, { name: 'Bb', val: [1,0,0] }, { name: 'B', val: [0,1,0] }, { name: 'C', val: [0,0,0] } ], 
                            'Mid': [ { name: 'C', val: [0,0,0] }, { name: 'C#/Db', val: [1,1,1] }, { name: 'D', val: [1,0,1] }, { name: 'Eb', val: [0,1,1] }, { name: 'E', val: [1,1,0] }, { name: 'F', val: [1,0,0] }, { name: 'F#/Gb', val: [0,1,0] }, { name: 'G', val: [0,0,0] }, { name: 'Ab', val: [0,1,1] }, { name: 'A', val: [1,1,0] }, { name: 'Bb', val: [1,0,0] }, { name: 'B', val: [0,1,0] }, { name: 'C↑', val: [0,0,0] } ], 
                            'High': [ { name: 'C', val: [0,0,0] }, { name: 'D', val: [1,0,0] }, { name: 'E', val: [0,0,0] }, { name: 'F', val: [1,0,0] }, { name: 'G', val: [0,0,0] }, { name: 'A', val: [1,1,0] }, { name: 'B', val: [0,1,0] }, { name: 'C↑', val: [0,0,0] } ] 
                        } },
                        'Baritone': { type: 'valves', notes: { 
                            'Low': [ { name: 'E', val: [1,1,1] }, { name: 'F', val: [1,0,1] }, { name: 'G', val: [1,1,0] }, { name: 'Ab', val: [1,0,0] }, { name: 'A', val: [0,1,0] }, { name: 'Bb', val: [0,0,0] } ], 
                            'Mid': [ { name: 'Bb', val: [0,0,0] }, { name: 'B', val: [1,1,1] }, { name: 'C', val: [1,0,1] }, { name: 'Db', val: [0,1,1] }, { name: 'D', val: [1,1,0] }, { name: 'Eb', val: [1,0,0] }, { name: 'E', val: [0,1,0] }, { name: 'F', val: [0,0,0] }, { name: 'Gb', val: [0,1,1] }, { name: 'G', val: [1,1,0] }, { name: 'Ab', val: [1,0,0] }, { name: 'A', val: [0,1,0] }, { name: 'Bb↑', val: [0,0,0] } ], 
                            'High': [ { name: 'Bb', val: [0,0,0] }, { name: 'C', val: [1,0,0] }, { name: 'D', val: [1,1,0] }, { name: 'Eb', val: [1,0,0] }, { name: 'F', val: [0,0,0] }, { name: 'G', val: [0,0,0] }, { name: 'A', val: [0,1,0] }, { name: 'Bb↑', val: [0,0,0] } ] 
                        } },
                        'Trombone': { type: 'slide', notes: { 
                            'Low': [ { name: 'E', pos: 7 }, { name: 'F', pos: 6 }, { name: 'G', pos: 4 }, { name: 'Ab', pos: 3 }, { name: 'A', pos: 2 }, { name: 'Bb', pos: 1 } ], 
                            'Mid': [ { name: 'Bb', pos: 1 }, { name: 'B', pos: 7 }, { name: 'C', pos: 6 }, { name: 'Db', pos: 5 }, { name: 'D', pos: 4 }, { name: 'Eb', pos: 3 }, { name: 'E', pos: 2 }, { name: 'F', pos: 1 }, { name: 'Gb', pos: 5 }, { name: 'G', pos: 4 }, { name: 'Ab', pos: 3 }, { name: 'A', pos: 2 }, { name: 'Bb↑', pos: 1 } ], 
                            'High': [ { name: 'Bb', pos: 1 }, { name: 'C', pos: 3 }, { name: 'D', pos: 1 }, { name: 'Eb', pos: 3 }, { name: 'F', pos: 1 }, { name: 'G', pos: 2 }, { name: 'Ab', pos: 3 }, { name: 'Bb↑', pos: 1 } ] 
                        } },
                        'Tuba': { type: 'valves', notes: { 
                            'Low': [ { name: 'E', val: [1,1,1] }, { name: 'F', val: [1,0,1] }, { name: 'G', val: [1,1,0] }, { name: 'Ab', val: [1,0,0] }, { name: 'A', val: [0,1,0] }, { name: 'Bb', val: [0,0,0] } ], 
                            'Mid': [ { name: 'Bb', val: [0,0,0] }, { name: 'B', val: [1,1,1] }, { name: 'C', val: [1,0,1] }, { name: 'Db', val: [0,1,1] }, { name: 'D', val: [1,1,0] }, { name: 'Eb', val: [1,0,0] }, { name: 'E', val: [0,1,0] }, { name: 'F', val: [0,0,0] }, { name: 'Gb', val: [0,1,1] }, { name: 'G', val: [1,1,0] }, { name: 'Ab', val: [1,0,0] }, { name: 'A', val: [0,1,0] }, { name: 'Bb↑', val: [0,0,0] } ], 
                            'High': [ { name: 'Bb', val: [0,0,0] }, { name: 'C', val: [1,0,0] }, { name: 'D', val: [1,1,0] }, { name: 'Eb', val: [1,0,0] }, { name: 'F', val: [0,0,0] }, { name: 'G', val: [0,0,0] }, { name: 'A', val: [0,1,0] }, { name: 'Bb↑', val: [0,0,0] } ] 
                        } }
                    }
                },

                // Audio Data for Pitch Pipe
                notes: [ { name: 'C', freq: 261.63 }, { name: 'C#', freq: 277.18 }, { name: 'D', freq: 293.66 }, { name: 'Eb', freq: 311.13 }, { name: 'E', freq: 329.63 }, { name: 'F', freq: 349.23 }, { name: 'F#', freq: 369.99 }, { name: 'G', freq: 392.00 }, { name: 'Ab', freq: 415.30 }, { name: 'A', freq: 440.00 }, { name: 'Bb', freq: 466.16 }, { name: 'B', freq: 493.88 } ],

                playToneEngine(freq) {
                    if (!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); 
                    
                    this.oscillator = this.audioCtx.createOscillator(); 
                    this.gainNode = this.audioCtx.createGain(); 
                    this.filterNode = this.audioCtx.createBiquadFilter();

                    const inst = this.interactiveChart.instrument;
                    if (inst === 'Flute') { this.oscillator.type = 'sine'; this.filterNode.type = 'lowpass'; this.filterNode.frequency.value = 2000; } 
                    else if (inst === 'Clarinet') { this.oscillator.type = 'square'; this.filterNode.type = 'lowpass'; this.filterNode.frequency.value = 1500; } 
                    else if (inst === 'Oboe') { this.oscillator.type = 'sawtooth'; this.filterNode.type = 'bandpass'; this.filterNode.frequency.value = 1200; } 
                    else if (['Trumpet', 'Trombone', 'Tenor Horn', 'Baritone', 'Tuba'].includes(inst)) { this.oscillator.type = 'sawtooth'; this.filterNode.type = 'lowpass'; this.filterNode.frequency.value = 2500; } 
                    else if (inst === 'French Horn') { this.oscillator.type = 'triangle'; this.filterNode.type = 'lowpass'; this.filterNode.frequency.value = 800; } 
                    else { this.oscillator.type = 'sawtooth'; this.filterNode.type = 'lowpass'; this.filterNode.frequency.value = 3000; }

                    this.oscillator.frequency.setValueAtTime(freq, this.audioCtx.currentTime); 
                    this.oscillator.connect(this.filterNode); 
                    this.filterNode.connect(this.gainNode);
                    this.gainNode.connect(this.audioCtx.destination);
                    
                    this.gainNode.gain.setValueAtTime(0, this.audioCtx.currentTime);
                    this.gainNode.gain.linearRampToValueAtTime(0.5, this.audioCtx.currentTime + 0.05);

                    this.oscillator.start(); 
                },

                playNote(baseFreq, noteName) { 
                    const cleanNoteName = noteName.split('/')[0].replace('↑', '');
                    const matchingFreqObj = this.notes.find(n => n.name === cleanNoteName);
                    const actualBaseFreq = matchingFreqObj ? matchingFreqObj.freq : baseFreq;
                    const actualFreq = actualBaseFreq * Math.pow(2, this.octave - 4);
                    const noteId = cleanNoteName + this.octave;

                    if (this.activeNote === noteId) { this.stopNote(); return; } 
                    this.stopNote();
                    
                    this.playToneEngine(actualFreq);
                    this.activeNote = noteId; 
                },

                stopNote() {
                    if (this.oscillator && this.gainNode) {
                        this.gainNode.gain.linearRampToValueAtTime(0, this.audioCtx.currentTime + 0.05);
                        setTimeout(() => { if(this.oscillator) { this.oscillator.stop(); this.oscillator.disconnect(); this.oscillator = null; } }, 50);
                        this.activeNote = null;
                    }
                },

                printStaves(count) {
                    const container = document.getElementById('print-staves');
                    container.innerHTML = '';
                    for(let i=0; i<count; i++) { container.innerHTML += `<div class='stave-group'><div class='stave'></div><div class='stave'></div><div class='stave'></div><div class='stave'></div><div class='stave'></div></div>`; }
                    window.print();
                }
            }));
        });
    </script>
</body>
</html>
